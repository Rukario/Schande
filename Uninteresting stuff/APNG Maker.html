<!DOCTYPE html>
<html>
<meta charset="utf-8"/>
<title>Make APNG</title>
<style>
html,body {background-color:#0c0c0c; color:#3f3; font-family:courier; font-size:14px;}
a{color:#6f8; text-decoration:none;}
.frame{display:inline-block; vertical-align:top; position:relative;}
input[type="file"] {display:none;}
::placeholder{color:#3cb;}
.previous{background-color:#4bb; color:#133; border:1px solid #033; border-radius:0px; cursor:pointer; font-size:12px; padding:2px 10px 2px; font-family:Arial;}
.next{background-color:#066; color:#6fe; border:1px solid #033; border-radius:0px; cursor:pointer; font-size:12px; padding:2px 10px 2px; font-family:Arial;}
.sources{font-size:80%; width:200px;}
.stdout {border:1px solid #333;}
@media (prefers-color-scheme: light) {
html,body {background-color:#eee; color:#333; font-family:courier; font-size:14px;}
.stdout {border:1px solid #999;}
}
</style>
<script>
function get_ext(f) {
  var fp = f.name.split('.');
  return fp[fp.length - 1];
}

function isImage(ext) {
  switch (ext.toLowerCase()) {
    case 'jpg':
    case 'jpeg':
    case 'gif':
    case 'bmp':
    case 'png':
      return true;
  }
  return false;
}

function isVideo(ext) {
  switch (ext.toLowerCase()) {
    case 'm4v':
    case 'avi':
    case 'mpg':
    case 'mp4':
    case 'webm':
      return true;
  }
  return false;
}

function setfps(text) {
  let d = document.getElementById("fps");
  if(isNaN(text)){
    d.style.backgroundColor = "#399"
    fps = 0;
  } else {
    if(0<text && text<=60){
      d.style.backgroundColor = "#066"
      fps = Number(text);
    } else {
      d.style.backgroundColor = "#399"
      fps = 0;
    }
  }
  if(!text){
    d.style.backgroundColor = "#066"
    fps = 0;
  }
}

function echo(B) {
  stdout = document.getElementById("stdout");
  stdout.innerHTML += "<br>" + B;
}

function ABtoURL(ab){
  return URL.createObjectURL(new Blob([ab], {type: 'application/octet-stream'}));
}

function echoABtoIMG(ab, B){
  stdout = document.getElementById("stdout");
  var src = ABtoURL(new Uint8Array(ab));
  img = document.createElement("img")
  img.src = src;
  img.style = "max-height:400px;"
  dl = document.createElement("a");
  dl.download = B + ".png";
  dl.href = src;
  dl.appendChild(img);
  stdout.innerHTML += "<br>"
  stdout.appendChild(dl);
}

function echoABtoDL(ab, B){
  stdout = document.getElementById("stdout");
  dl = document.createElement("a")
  dl.href = ABtoURL(new Uint8Array(ab));
  dl.download = B + ".png";
  dl.innerHTML = "<br>" + B
  stdout.appendChild(dl);
}

function canvasToAB(c) {
  return function(resolve) {
    c.toBlob((blob0) => {
      var fr = new FileReader();
      fr.readAsArrayBuffer(blob0);
      fr.onload = () => {
        arri = new Uint8Array(fr.result);
        var Module = {};
        if(optimize){
          //https://manpages.debian.org/stretch/optipng/optipng.1.en.html
          //Ideal settings for apng production
          arri = optipng(arri, ['-force', '-zw', '32k', '-f', '0', '-zs', '0', '-zm', '8', '-zc', '9', '-nx', '-strip', 'all']).data;
        }
        resolve(arri);
      };
    }, 'image/png');
  }
}

function emergen(c, callback, i){
  var promise = new Promise(canvasToAB(c))
  promise.then(function(arri){
    arri = Array.from(arri);
    frameBytes.bin = arri;
    if(i == undefined){
      addframe(c, 1);
    } else {
      addframe(c, fps);
    }
    if(callback){
      if(i !== undefined){
        //echoABtoIMG(arri, "Frame " + (i+1));
        echo("Frame " + (i+1));
        document.title = "Frame " + (i+1);
        callback(i+1);
      } else {
        //echoABtoIMG(arri, "Resave as");
        document.title = "Make APNG";
        callback();
      }
    }
  })
}

function Convolute(pixels, weights) {
  var side = Math.round(Math.sqrt(weights.length));
  var halfSide = Math.floor(side/2);

  var src = pixels.data;
  var sw = pixels.width;
  var sh = pixels.height;

  var w = sw;
  var h = sh;
  var f = document.createElement('canvas').getContext('2d');
  var output = f.createImageData(w, h);
  var dst = output.data;

  for (var y=0; y<h; y++) {
    for (var x=0; x<w; x++) {
      var sy = y;
      var sx = x;
      var dstOff = (y*w+x)*4;
      var r=0, g=0, b=0, a=0;
      for (var cy=0; cy<side; cy++) {
        for (var cx=0; cx<side; cx++) {
          var scy = Math.min(sh-1, Math.max(0, sy + cy - halfSide));
          var scx = Math.min(sw-1, Math.max(0, sx + cx - halfSide));
          var srcOff = (scy*sw+scx)*4;
          var wt = weights[cy*side+cx];
          r += src[srcOff] * wt;
          g += src[srcOff+1] * wt;
          b += src[srcOff+2] * wt;
          a += src[srcOff+3] * wt;
        }
      }
      dst[dstOff] = r;
      dst[dstOff+1] = g;
      dst[dstOff+2] = b;
      dst[dstOff+3] = 255;
    }
  }
  return output;
}

function edge(s, cw, ch, context) {
  context.drawImage(s, 0, 0, cw, ch);
  rgb = context.getImageData(0, 0, cw, ch);
  rgb = Convolute(rgb, [-1, -1, -1, -1,  8, -1, -1, -1, -1])
  context.putImageData(rgb, 0, 0);
  echo("Edge Detect")
  emergen(c, staticAPNG)
}

function ghost(rgb) {
  for (var i = 0; i < rgb.length; i += 4) {
    if(rgb[i] == 0 && rgb[i+1] == 0 && rgb[i+2] == 0){
      rgb[i] = 0;
      rgb[i+1] = 0;
      rgb[i+2] = 0;
      rgb[i+3] = 255;
    } else if(rgb[i] > 12 || rgb[i+1] > 12 || rgb[i+2] > 12){
      rgb[i] = 255;
      rgb[i+1] = 255;
      rgb[i+2] = 255;
      rgb[i+3] = 255;
    } else if(rgb[i] > 10 || rgb[i+1] > 10 || rgb[i+2] > 10){
      rgb[i] = 208;
      rgb[i+1] = 192;
      rgb[i+2] = 240;
      rgb[i+3] = 255;
    } else if(rgb[i] > 8 || rgb[i+1] > 8 || rgb[i+2] > 8){
      rgb[i] = 176;
      rgb[i+1] = 128;
      rgb[i+2] = 224;
      rgb[i+3] = 255;
    } else if(rgb[i] > 6 || rgb[i+1] > 6 || rgb[i+2] > 6){
      rgb[i] = 144;
      rgb[i+1] = 64;
      rgb[i+2] = 192;
      rgb[i+3] = 255;
    } else if(rgb[i] > 4 || rgb[i+1] > 4 || rgb[i+2] > 4){
      rgb[i] = 112;
      rgb[i+1] = 32;
      rgb[i+2] = 160;
      rgb[i+3] = 255;
    } else if(rgb[i] > 2 || rgb[i+1] > 2 || rgb[i+2] > 2){
      rgb[i] = 64;
      rgb[i+1] = 16;
      rgb[i+2] = 128;
      rgb[i+3] = 255;
    } else if(rgb[i] > 0 || rgb[i+1] > 0 || rgb[i+2] > 0){
      rgb[i] = 32;
      rgb[i+1] = 8;
      rgb[i+2] = 96;
      rgb[i+3] = 255;
    };
  }
}

function detect() {
  let p = document.getElementById("framelist");
  d = p.innerHTML.split("<br>").filter(function(el) { return el; })
  c = canvas(framearray[d[0]-1]);
  context = c.getContext("2d");
  dim = [0, 0, c.width, c.height]
  if(d.length > 1) {
    if(fps == 0){
      echo("Bad FPS")
    } else {
      apngdiff(framearray[d[0]-1], framearray[d[1]-1], c.width, c.height, context);
    }
  } else {
    edge(framearray[d[0]-1], c.width, c.height, context);
  }
}

function diff(a, b) {
  for (var i = 0; i < b.length; i += 4) {
    if (a[i] == b[i] && a[i+1] == b[i+1] && a[i+2] == b[i+2]) {
      b[i+3] = 0
    }
  }
}

function darkside(a, b) {
  for (var i = 0; i < b.length; i += 4) {
    b[i] -= a[i];
    b[i+1] -= a[i+1];
    b[i+2] -= a[i+2];
  }
  ghost(b)
}

function darkdiff(a, b) {
  for (var i = 0; i < b.length; i += 4) {
    b[i] = Math.abs(b[i] - a[i]);
    b[i+1] = Math.abs(b[i+1] - a[i+1]);
    b[i+2] = Math.abs(b[i+2] - a[i+2]);
  }
  ghost(b)
}

function apngdiff(m, s, cw, ch, context) {
  context.drawImage(m, 0, 0, cw, ch);
  rgb = context.getImageData(0, 0, cw, ch)
  emergen(c, f2, 0);

  function f2(){
  context.drawImage(s, 0, 0, cw, ch);
  rgb2 = context.getImageData(0, 0, cw, ch)
  diff(rgb.data, rgb2.data)
  context.putImageData(rgb2, 0, 0);
  emergen(c, f3, 1);
  }

  function f3(){
  context.drawImage(m, 0, 0, cw, ch);
  rgb2 = context.getImageData(0, 0, cw, ch)
  diff(rgb.data, rgb2.data)
  context.putImageData(rgb2, 0, 0);
  emergen(c, f4, 0);
  }

  function f4(){
  context.drawImage(s, 0, 0, cw, ch);
  rgb2 = context.getImageData(0, 0, cw, ch)
  diff(rgb.data, rgb2.data)
  context.putImageData(rgb2, 0, 0);
  emergen(c, f5, 1);
  }

  function f5(){
  context.drawImage(s, 0, 0, cw, ch);
  rgb2 = context.getImageData(0, 0, cw, ch)
  darkside(rgb.data, rgb2.data);
  context.putImageData(rgb2, 0, 0);
  emergen(c, f6, -2);
  }
  
  function f6(){
  context.drawImage(s, 0, 0, cw, ch);
  rgb2 = context.getImageData(0, 0, cw, ch);
  darkdiff(rgb.data, rgb2.data);
  context.putImageData(rgb2, 0, 0);
  emergen(c, f7, -2.5);
  }

  function f7(){
  context.drawImage(s, 0, 0, cw, ch);
  rgb2 = context.getImageData(0, 0, cw, ch);
  darkside(rgb2.data, rgb.data);
  context.putImageData(rgb, 0, 0);
  emergen(c, makeapng, -3);
  }
}

function canvas(image) {
  var c = document.createElement("canvas");
  //sets max width, divide by 2 when exceeded, increment division times when 2 isn't enough
  var len = Math.ceil(image.width / 3000)
  c.width = Math.floor(image.width / len)
  c.height = Math.floor(image.height / len)
  return c
}

function addframe(c, fps){
  frame += 1;
  if (!frame) {
    apngBytes.bin = apngBytes.bin.concat(PNG_signature);

    var chunk = frameBytes.findChunk("IHDR");
    var chunkSlice = frameBytes.bin.slice(chunk.idx, chunk.idx + 12 + chunk.len);
    apngBytes.bin = apngBytes.bin.concat(chunkSlice);

    var acTL = new Array(0);
    acTL = acTL.concat([0x00, 0x00, 0x00, 0x08, 0x61, 0x63, 0x54, 0x4C]);
    acTL = acTL.concat([0,0,0,1]);
    acTL = acTL.concat([0,0,0,0]);
    acTL = acTL.concat( int32ToBytes4(crc32(acTL.slice(4, 4 + 4 + 8))) );
    apngBytes.bin = apngBytes.bin.concat(acTL);
  }

  var chunkArray = frameBytes.findChunkAll("IDAT");
  //echo("IDATs: " + chunkArray.length)
  for (var i = 0; i < chunkArray.length; i++) { 
    if (!i) {
      //echo(i + "th IDAT size: " + chunkArray[i].len)
      seqNumber +=1;
      var fcTL = new Array(0);
      fcTL = fcTL.concat( int32ToBytes4(26) );
      fcTL = fcTL.concat([0x66, 0x63, 0x54, 0x4C]);
      fcTL = fcTL.concat( int32ToBytes4(seqNumber) );
      fcTL = fcTL.concat( int32ToBytes4(c.width) );
      fcTL = fcTL.concat( int32ToBytes4(c.height) );
      fcTL = fcTL.concat( int32ToBytes4(dim[0]) );
      fcTL = fcTL.concat( int32ToBytes4(dim[1]) );
      fcTL = fcTL.concat( int16ToBytes2(1000/fps) );
      fcTL = fcTL.concat( int16ToBytes2(1000) );
      fcTL = fcTL.concat([0x00]);
      fcTL = fcTL.concat( [blend] );
      fcTL = fcTL.concat(int32ToBytes4(crc32(fcTL.slice(4, 4+4+26))));
      apngBytes.bin = apngBytes.bin.concat(fcTL);
    }
    chunk = chunkArray[i];

    if (!frame) {
      var chunkSlice = frameBytes.bin.slice(chunk.idx, chunk.idx + 12 + chunk.len);
      apngBytes.bin = apngBytes.bin.concat(chunkSlice)
    } else {
      var chunk_IDAT_data = frameBytes.bin.slice(chunk.idx + 8, chunk.idx + 8 + chunk.len);
      var len_fdAT = chunk.len + 4;

      seqNumber +=1;
      var fdAT = new Array(0);
      fdAT = fdAT.concat( int32ToBytes4(len_fdAT) );
      fdAT = fdAT.concat( [0x66, 0x64, 0x41, 0x54] );
      fdAT = fdAT.concat( int32ToBytes4(seqNumber) );
      fdAT = fdAT.concat( chunk_IDAT_data );
      fdAT = fdAT.concat( int32ToBytes4(crc32(fdAT.slice(4, 4 + 4 + len_fdAT))) );
      apngBytes.bin = apngBytes.bin.concat(fdAT);
    };
  }
}

var PNG_signature = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
var IEND = [0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82];
var frame = -1
var apngBytes = new ByteArray(0);
var frameBytes = new ByteArray(0);
var seqNumber = -1
var blend = 1;
    
function makeapng(i) {
  apngBytes.bin = apngBytes.bin.concat(IEND);

  var chunk = apngBytes.findChunk("acTL");
  var nFrames = int32ToBytes4(frame + 1);
  apngBytes.bin[chunk.idx+8] = nFrames[0];
  apngBytes.bin[chunk.idx+8+1] = nFrames[1];
  apngBytes.bin[chunk.idx+8+2] = nFrames[2];
  apngBytes.bin[chunk.idx+8+3] = nFrames[3];

  var acTLslice = apngBytes.bin.slice(chunk.idx+4, chunk.idx+4+4+8);
  var crcBytes = int32ToBytes4(crc32(acTLslice));
  apngBytes.bin[chunk.idx+4+4+8] = crcBytes[0];
  apngBytes.bin[chunk.idx+4+4+8+1] = crcBytes[1];
  apngBytes.bin[chunk.idx+4+4+8+2] = crcBytes[2];
  apngBytes.bin[chunk.idx+4+4+8+3] = crcBytes[3];

  frame = -1
  frameBytes = new ByteArray(0);
  seqNumber = -1

  echoABtoIMG(apngBytes.bin, name.split('.').slice(0, -1).join('.') + " (apng)");
  document.title = "Make APNG";
  apngBytes = new ByteArray(0);
}

function base64ToAB(base64) {
  var utf8 = atob(base64);
  var len = utf8.length;
  var arr = new Array(len);
  for (var i = 0; i < len; ++i) {
    arr[i] = utf8.charCodeAt(i);
  }
  return arr;
}

function ABToBase64(buffer) {
  var binary = "";
  for (var i = 0; i < buffer.length; i++)
    binary += String.fromCharCode(buffer[i]);
  return btoa(binary);
}

function ByteArray(len) {
  this.bin = new Array(len);
  function Chunk(idx, len, type) {
     this.idx = idx;
     this.len = len;
     this.type = type;
  }
  this.findChunk =
    function(iType) {
      var offset = 8;
      var chunk = null;
      while (offset < this.bin.length) {
        var chunk1 = this.bin.slice(offset, offset + 4);
        var chunk2 = this.bin.slice(offset + 4, offset + 8);
        var chunkLength = bytes4ToInt32(chunk1);
        if (bytes4ToStr4(chunk2) === iType) {
          chunk = new Chunk(offset, chunkLength, iType);
          return chunk;
        }
        offset += 4 + 4 + chunkLength + 4;
      }
      return chunk;
    }
  this.findChunkAll =
    function(iType) {
      var offset = 8;
      var chunkArray = [];
      while (offset < this.bin.length) {
        //echo("Current BIN size: " + this.bin.length)
        var chunk1 = this.bin.slice(offset, offset + 4);
        var chunk2 = this.bin.slice(offset + 4, offset + 8);
        var chunkLength = bytes4ToInt32(chunk1);
        if (bytes4ToStr4(chunk2) === iType) {
          if(chunk1[0]||chunk1[1]){
            chunkLength = this.bin.length-8-25-12-12; //-PNG signature -IHDR -UNK -IEND
          }
          //echo("Added " + chunkLength + " bytes to apngBytes.bin")
          chunk = new Chunk(offset, chunkLength, iType);
          chunkArray.push(chunk);
        }
        offset += 4 + 4 + chunkLength + 4;
      }
      return chunkArray;
    }
  return this;
}

function bytes4ToStr4(iBytes) {
   var cc = 
     String.fromCharCode(iBytes[0]) +
     String.fromCharCode(iBytes[1]) +
     String.fromCharCode(iBytes[2]) +
     String.fromCharCode(iBytes[3]);
   return cc;
}

function int32ToBytes4(iNum) {
   var int32 = iNum;
   var arr = [0, 0, 0, 0];
   for ( var idx = 0; idx < arr.length; idx ++ ) {
      var byte = int32 & 0xff;
      arr[idx] = byte;
      int32 = (int32 - byte) / 256 ;
   }
   return arr.reverse();
}

function bytes4ToInt32(iBytes) {
   var num = (iBytes[0] << 24) + (iBytes[1] << 12) + (iBytes[2] << 8) + iBytes[3];
   return num;
}

function int16ToBytes2(iNum) {
   var int16 = iNum;
   var arr = [0, 0];
   for ( var idx = 0; idx < 2; idx ++ ) {
      var byte = int16 & 0xff;
      arr[idx] = byte;
      int16 = (int16 - byte) / 256 ;
   }
   return arr.reverse();
}

var table = new Uint32Array(256);
for (var i = 0; i < 256; i++) {
  var c = i;
  for (var k = 0; k < 8; k++) c = (c & 1) ? 0xEDB88320 ^ (c >>> 1) : c >>> 1;
  table[i] = c;
}

function crc32(ab) {
  var crc = -1;
  for (var i=0; i < ab.length; i++) {
    crc = ( crc >>> 8 ) ^ table[( crc ^ ab[i] ) & 0xFF];
  }
  return (crc ^ (-1)) >>> 0;
}

var dim;
function diff(a, b) {
  var d = {x:[], y:[]};
  for(var y=0;y<h;y++){
    var o = (y+1)*w
    for(var x=(o-w)*4;x<o*4;x+=4){
      if(b[x+3] == 0 || a[x+3] == 255 && a[x] == b[x] && a[x+1] == b[x+1] && a[x+2] == b[x+2]){
        b[x+3] = 0;
      } else {
        d.x.push((x/4)+w-o);
        d.y.push(y);
      }
    }
  }
  d.x.sort((a,b) => a-b);
  d.y.sort((a,b) => a-b);
  dim = [d.x[0], d.y[0], d.x[d.x.length-1]-d.x[0]+1, d.y[d.y.length-1]-d.y[0]+1];
}

function staticAPNG(){
  c.width = 1;
  c.height = 1;
  context.clearRect(0, 0, 1, 1);
  emergen(c, makeapng);
}

var framearray = []
var c, context, w, h;
function compileframes(){
  let p = document.getElementById("framelist");
  d = p.innerHTML.split("<br>").filter(function(el) { return el; })
  function readFrame(i){
    if(i == 0){
      c = canvas(framearray[d[i]-1]);
      w = c.width;
      h = c.height;
      dim = [0, 0, w, h]
    } else {
      c = document.createElement("canvas");
      c.width = w;
      c.height = h;
    }
    context = c.getContext("2d");
    context.drawImage(framearray[d[i]-1], 0, 0, w, h);
    if(frameSaver){
      if(i == 0){
        rgb = context.getImageData(0, 0, w, h).data;
      } else {
        var imageData = context.getImageData(0, 0, w, h);
        rgb2 = imageData.data;
        diff(rgb, rgb2)
        rgb = context.getImageData(0, 0, w, h).data;
        context.putImageData(imageData, 0, 0);
        if(dim[0] == undefined){
          c.width = 1;
          c.height = 1;
          context.clearRect(0, 0, 1, 1);
        } else {
          var cropped = context.getImageData(dim[0], dim[1], dim[2], dim[3]);
          c.width = dim[2];
          c.height = dim[3];
          context.putImageData(cropped, 0, 0);
        }
      }
    }
    if(i+1 == d.length){
      if(1 == d.length){
        echo("Resave as");
        emergen(c, staticAPNG);
      } else {
        emergen(c, makeapng, i);
      }
    } else {
      if(fps == 0){
        echo("Bad FPS")
      } else {
        emergen(c, readFrame, i);
      }
    }
  }
  readFrame(0);
}

function editlist(){
  var e = document.getElementById("framelist");
  e.innerHTML = ""
  for(var i=1;i<framearray.length+1;i++){
    e.innerHTML = e.innerHTML + i + "<br>"
  }

  e = document.getElementById("makeapng");
  e.setAttribute("onclick", "compileframes();")
  e.classList = "next";

  e = document.getElementById("detect");
  e.setAttribute("onclick", "detect();")
  e.classList = "next";
}

function read(filelist){
  filelist = Array.from(filelist).sort((a,b) => a.name > b.name);
  name = filelist[0].name;
  function readFile(i){
    if(i == filelist.length) return;
    var fr = new FileReader();
    fr.readAsArrayBuffer(filelist[i]);
    fr.onload = () => {
      arri = new Uint8Array(fr.result);
      img = new Image();
      img.src = ABtoURL(arri)
      img.onload = () => {
        framearray.push(img);
        if(i+1 == filelist.length){
          editlist();
        } else {
          readFile(i+1);
        }
      }
    }
  }
  readFile(0);
}

var fps = 0;
var frameSaver = true;
var optimize = false;
var arri, arro, stdout, dl, img, Module, name, rgb, rgb2;

window.onload = () => {
  document.body.innerHTML = `<label class="next"><input id="frames" type="file" multiple></input>Load Frames</label>
<label class="next"><input id="more" type="file" multiple></input>Load More</label>
<label class="next" id="jsload"><input id="js" type="file" accept=".js, text/javascript"></input>Load optipng.js</label><button style="background: none; border:none; color:inherit; cursor:pointer;" onclick="echo('Optimize frames with <a href=&quot;https://github.com/LI-NA/optipng.js/tree/master/demo/js&quot; target=&quot;_blank&quot;>optipng.min.js</a> (minified of optipng.js), save next to HTML to load it automatically')">what?</button><label class="next"><input id="viewer" type="file"></input>Echo File</label>
<p>
<div style="display:inline-block; width:340px; vertical-align: text-top;">
<p id="framelist" class="stdout" style="background-color:#181818; color:#fd6; display:inline-block; padding:8px;" onpaste="plaintext(this, event);" contenteditable>
<div style="float:right; width:300px;">Edit list to rearrange, repeat, or skip a frame by number associated to filelist order, please do not exceed current max number.</div>
</div>
<p>
<button class="previous" onclick="echo('Filelist is empty!')" id="makeapng">Make APNG</button> <button class="previous" onclick="echo('Filelist is empty!')" id="detect">Detect</button> at <input id="fps" class="next" type="text" oninput="setfps(this.value);" style="padding: 1px 10px 1px; width:22px;" placeholder="Bad"> fps
<br><p class="stdout" id="stdout" style="background-color:#181818; color:#888; display:inline-block; padding:8px;">`
  document.getElementById("viewer").addEventListener('change', (event) => {
    stdout = document.getElementById("stdout");
    stdout.innerHTML += "<br>";
    var f = event.target.files[0];
    if (isVideo(get_ext(f))) {
      var v = document.createElement("video");
      v.style = "max-height:400px;"
      v.setAttribute("controls", "");
      v.setAttribute("playsinline", "");
      v.src = window.URL.createObjectURL(f);
      stdout.appendChild(v);
      v.play();
    } else if (isImage(get_ext(f))) {
      var img = document.createElement("img")
      var src = window.URL.createObjectURL(f);
      img.src = src;
      img.style = "max-height:400px;"
      var dl = document.createElement("a");
      dl.download = f.name;
      dl.href = src;
      dl.appendChild(img);
      stdout.appendChild(dl);
    } else {
      stdout.innerHTML += "Maybe try another program.";
    }
  });
  
  document.getElementById("frames").addEventListener('change', (event) => {
    framearray = [];
    read(event.target.files);
  });
  
  document.getElementById("more").addEventListener('change', (event) => {
    read(event.target.files);
  });
  
  document.addEventListener("dragover", (event) => {
    event.preventDefault();
    event.dataTransfer.dropEffect = 'copy';
  });
  
  document.addEventListener("drop", (event) => {
    event.preventDefault();
    framearray = [];
    read(event.dataTransfer.files);
  });
  
  document.getElementById("js").addEventListener('change', (event) => {
    var fr = new FileReader();
    fr.readAsArrayBuffer(event.target.files[0]);
    fr.onload = () => {
      var d = document.getElementById("jsload");
      d.classList = "previous";
      d.setAttribute("onclick", "echo('Already loaded!')")
      d.innerHTML = "optipng.js armed";
      var s = document.createElement("script");
      s.src = ABtoURL(new Uint8Array(fr.result));
      document.body.appendChild(s);
      optimize = true;
    }
  });
  
  var jslist = ["optipng.min.js", "optipng.js"]
  function NextJs(i){
    if(i>=jslist.length){return;}
    var s = document.createElement("script");
    s.src = jslist[i];
    document.body.appendChild(s);
    s.onload = () => {
      if(Module){
        var d = document.getElementById("jsload");
        d.classList = "previous";
        d.setAttribute("onclick", "echo('Already loaded!')")
        d.innerHTML = "optipng.js armed";
        optimize = true;
      }
    }
    s.onerror = () => {
      NextJs(i+1)
    }
  }
  NextJs(0)
}
</script>
<body>☠️</body>
</html>