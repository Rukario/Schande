<!DOCTYPE html>
<html>
<meta charset="UTF-8"/>
<meta name="format-detection" content="telephone=no">
<title>Make APNG</title>
<style>
html,body {caret-color:#ff8228; font-family:courier; font-size:14px; margin-bottom:-2px; padding-top:2px; padding:2px;}
[contenteditable]:focus {outline: none;}
a {color:#ff9449;}
a:visited {color:#ffc66d;}
.frame{display:inline-block; vertical-align:top; position:relative;}
input[type="file"] {display:none;}
::placeholder{color:#3cb;}
.next{background-color:#066; color:#6fe; border:1px solid #033}
.previous{background-color:#4bb; color:#133; border:1px solid #033}
.reverse{background-color:#428; color:#d9f; border:1px solid #214}
.inverse{background-color:#d9f; color:#428; border:1px solid #214}
.menu {color:#9b859d; background-color:#110c13;}
.exitmenu {color:#f45; background-color:#2d0710;}
.tooltip {background:#2d0710; border:1px solid #772227; color:inherit; position:relative; cursor:default; font-size:12px; padding:4px 11px; line-height:1.1;}
.previous, .reverse, .inverse, .next {border-radius:0px; cursor:pointer; font-size:12px; padding:4px 11px; font-family:Arial; margin:6px 0px;}
.cell {display:inline-block; width: 360px; vertical-align: text-top; border:2px solid #772227; padding-left:10px;}
.stdout {white-space:pre-wrap; line-height:1.1; color:#9b859d; background-color:#110c13; border:2px solid #221926; display:inline-block; padding:6px; margin-top:12px; min-height:0px;}
</style>
<script>
var FFdown = function(e) {
  var t = e.target;
  var a = t.parentNode;
  if (t.hasAttribute("data-tooltip")) {
    tooltip.style.display = "inline-block";
    tooltip.innerHTML = t.getAttribute("data-tooltip");
    let left = () => {
      setTimeout(function(){
        tooltip.style.display = "none";
      }, 1250)
      a.removeEventListener("mouseleave", left);
    }
    a.addEventListener("mouseleave", left);
  }
}

document.addEventListener("click", FFdown);

function plaintext(elem, e) {
  e.preventDefault();
  var text = e.clipboardData.getData('text/plain').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  document.execCommand('insertHTML', false, text);
}

function quicklook(e) {
  if(e.target.classList.contains("lazy")) {
    e.preventDefault();
    var t = e.target;
    var c = {};

    var m = new Image();
    m.src = t.parentNode.getAttribute("href");
    var s = new Image();
    s.src = t.parentNode.parentNode.parentNode.childNodes[1].childNodes[0].getAttribute("href");

    c = document.createElement("canvas");
    get_dim(m);
    new_dim = [...dim];
    context = c.getContext("2d");
    c.width = dim[2];
    c.height = dim[3];

    if(s.src == m.src) {
      context.fillRect(...dim);
    } else {
      m.onload = function () {
        fps = 2
        //s.onload = apngdiff(m, s);
        s.onload = canvasdiff(m, s);
      }
    }

    //c = document.createElement("img");
    //c.setAttribute("src", t.parentNode.getAttribute("href"));

    c.style = cs;
    c.setAttribute("id", "quicklook");
    t.parentNode.appendChild(c);

    let listener = () => {
      setTimeout(function(){t.parentNode.removeChild(c);}, 40);
      t.removeEventListener("mouseleave", listener);
    }
    t.addEventListener("mouseleave", listener);
  }
}

document.addEventListener("mouseover", quicklook);

var co = "position:fixed; right:0; top:0; z-index:1; pointer-events:none;"
var cf = co + "max-height: 100vh; max-width: 100vw;";
var cs = cf

function lazyload() {
  var lazyloadImages;

  lazyloadImages = document.querySelectorAll(".lazy");
  var imageObserver = new IntersectionObserver(function(entries, observer) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        var image = entry.target;
        image.src = image.dataset.src;
        imageObserver.unobserve(image);
      }
    });
  });

  lazyloadImages.forEach(function(image) {
    image.style.height = "200px"
    image.style.width = "auto"
    imageObserver.observe(image);
  });
}

var Expand = function(c, t) {
  if(!c.naturalWidth)
  {
    return setTimeout(Expand, 10, c, t);
  }
  c.style.maxWidth = "100%";
  c.style.display = "";
  t.style.display = "none";
  t.style.opacity = "";
};

var Expander = function(e) {
  var t = e.target;
  if(t.parentNode.classList.contains("fileThumb")) {
    e.preventDefault();
    if(t.hasAttribute("data-src")) {
      var c = document.createElement("img");
      c.setAttribute("src", t.parentNode.getAttribute("href"));
      c.style.display = "none";
      t.parentNode.appendChild(c);
      t.style.opacity = "0.75";
      setTimeout(Expand, 10, c, t);
    } else {
      var a = t.parentNode;
      a.firstChild.style.display = "";
      a.removeChild(t);
      a.offsetTop < window.pageYOffset && a.scrollIntoView({top: 0, behavior: "smooth"});
    }
  }
};

function get_ext(f) {
  var fp = f.name.split('.');
  return fp[fp.length - 1];
}

function isImage(ext) {
  switch (ext.toLowerCase()) {
    case 'jpg':
    case 'jpeg':
    case 'gif':
    case 'bmp':
    case 'png':
      return true;
    case 'heic':
      return 'heic';
  }
  return false;
}

function isVideo(ext) {
  switch (ext.toLowerCase()) {
    case 'm4v':
    case 'avi':
    case 'mpg':
    case 'mp4':
    case 'webm':
      return true;
  }
  return false;
}

function setfps(text) {
  let d = document.getElementById("fps");
  if(isNaN(text)){
    d.style.backgroundColor = "#399"
    fps = 0;
  } else {
    if(0<text && text<=120){
      d.style.backgroundColor = "#066"
      fps = Number(text);
    } else {
      d.style.backgroundColor = "#399"
      fps = 0;
    }
  }
  if(!text){
    d.style.backgroundColor = "#066"
    fps = 0;
  }
}

function echo(B, b) {
  if (!b) B = "<br>" + B
  if (b) B = " " + B
  stdout.insertAdjacentHTML("beforeend", B);
}

function ABtoURL(ab){
  return URL.createObjectURL(new Blob(ab, {type: 'application/octet-stream'}));
}

function ABtoIMG(ab){
  img = document.createElement("img")
  img.src = ABtoURL(ab);
  return img;
}

function ABtoAB(ab){
  return [new Uint8Array(ab)]
}

function echoIMG(img, B){
  img.style = "max-height:400px;"
  dl = document.createElement("a");
  dl.download = B;
  dl.href = img.src;
  dl.appendChild(img);
  stdout.insertAdjacentHTML("beforeend", "<br>");
  stdout.appendChild(dl);
}

function echoABtoDL(ab, B){
  dl = document.createElement("a")
  dl.href = ABtoURL(ABtoAB(ab));
  dl.download = B;
  dl.innerHTML = "<br>" + B
  stdout.appendChild(dl);
}

function echoIMGfromCanvas(c, B=undefined, ext='png') {
  var promise = new Promise(canvasToAB(c, ext))
  promise.then(function(arri){
    echoIMG(ABtoIMG(ABtoAB(arri)), B)
  })
}

function echoHEIC(image, B) {
  c = document.createElement("canvas");
  c.width = image.get_width();
  c.height = image.get_height();
  context = c.getContext("2d");
  image.display(context.createImageData(c.width, c.height), function(display_image_data) {
    context.putImageData(display_image_data, 0, 0);
    echoIMGfromCanvas(c, B, 'jpeg');
  });
};

function echoPalette(h=8, s=1){
  palette.sort();
  var cc = document.createElement("canvas");
  var ccontext = cc.getContext("2d");
  var w = Math.ceil(palette.length/h)
  cc.width = w*s;
  cc.height = h*s;

  var img = ccontext.createImageData(w, h);
  var data = img.data;
  for(var i=0;i<palette.length;i++){
    data[i*4] = parseInt(palette[i].slice(0, 2), 16);
    data[i*4+1] = parseInt(palette[i].slice(2, 4), 16);
    data[i*4+2] = parseInt(palette[i].slice(4, 6), 16);
    data[i*4+3] = 255;
  }
  ccontext.putImageData(img, 0, 0);

  var p = document.createElement("canvas");
  var pcontext = p.getContext("2d");
  p.width = cc.width;
  p.height = cc.height;

  pcontext.imageSmoothingEnabled = false;
  pcontext.scale(s, s)
  pcontext.drawImage(cc, 0, 0, p.width, p.height, 0, 0, cc.width, cc.height);
  echoIMGfromCanvas(p);
  palette = [];
}

function canvasToAB(c, ext="png") {
  return function(resolve) {
    c.toBlob((blob0) => {
      var fr = new FileReader();
      fr.readAsArrayBuffer(blob0);
      fr.onload = () => {
        arri = new Uint8Array(fr.result);
        Module = {};
        ti[2] = performance.now()
        //echo((ti[2] - ti[1])/1000 + "s canvasToAB(c)")
        ti[1] = performance.now()
        if(ext == "png" && optimize){
          //https://manpages.debian.org/stretch/optipng/optipng.1.en.html
          //Ideal settings for apng production
          arri = optipng(arri, ['-force', '-zw', '32k', '-f', '0', '-zs', '0', '-zm', '8', '-zc', '9', '-nx', '-strip', 'all']).data;
        }
        ti[2] = performance.now()
        //echo((ti[2] - ti[1])/1000 + "s OptiPNG")
        resolve(arri);
      };
    }, 'image/' + ext);
  }
}

function fullres() {
  dim = [...orig_dim];
  di.innerHTML = dim[2] + " &times; " + dim[3];
}

function get_dim(image, enablescaling) {
  orig_dim = [0, 0, image.width, image.height];
  if (enablescaling) {
    //sets max dimension, divide by 2 when exceeded, increment division times when 2 isn't enough
    var len = Math.ceil(image.width / 4000)
    var leny = Math.ceil(image.height / 4000)
    if (leny > len) len = leny;
    dim = [0, 0, Math.floor(orig_dim[2] / len), Math.floor(orig_dim[3] / len)]
    di.innerHTML = dim[2] + " &times; " + dim[3];
    if (len > 1){
      di.innerHTML += " <button class='tooltip' onclick='fullres()'>use original</button>"
    }
  } else {
    dim = [...orig_dim];
  }
}

function ABtoFrame(arri, callback, interFrameN, fpsm=1, callback2=false, filler=false){
  ti[1] = performance.now()
  arri = Array.from(arri);
  newframe.arri = arri;
  ti[2] = performance.now()
  //echo((ti[2] - ti[1])/1000 + "s ArrayBuffer")
  if(interFrameN == undefined){
    document.title = "Make APNG";
    //echoIMG(ABtoIMG(ABtoAB(arri)), "Resave as" + ".png");
    toFrame([1000, 1000]);
    callback(0, callback2);
  } else {
    let buffer;
    if (filler){
      echo("APNGified")
    } else {
      echo("Frame " + (interFrameN+1));
      document.title = "Frame " + (interFrameN+1);
      //echoIMG(ABtoIMG(ABtoAB(arri)), "Frame " + (interFrameN+1) + ".png");
    }
    toFrame([1000/(fps/fpsm), 1000]);
    callback(interFrameN + nextFrame, callback2);
  }
}

function canvasToFrame(callback, interFrameN, fpsm=1, callback2=false, filler=false){
  ti[1] = performance.now()
  let promise = new Promise(canvasToAB(c))
  promise.then(function(arri){
    ABtoFrame(arri, callback, interFrameN, fpsm, callback2, filler)
  })
}

function Convolute(pixels, weights) {
  var side = Math.round(Math.sqrt(weights.length));
  var halfSide = Math.floor(side/2);

  var src = pixels.data;
  var sw = pixels.width;
  var sh = pixels.height;

  var w = sw;
  var h = sh;
  var f = document.createElement('canvas').getContext('2d');
  var output = f.createImageData(w, h);
  var dst = output.data;

  for (var y=0; y<h; y++) {
    for (var x=0; x<w; x++) {
      var sy = y;
      var sx = x;
      var dstOff = (y*w+x)*4;
      var r=0, g=0, b=0, a=0;
      for (var cy=0; cy<side; cy++) {
        for (var cx=0; cx<side; cx++) {
          var scy = Math.min(sh-1, Math.max(0, sy + cy - halfSide));
          var scx = Math.min(sw-1, Math.max(0, sx + cx - halfSide));
          var srcOff = (scy*sw+scx)*4;
          var wt = weights[cy*side+cx];
          r += src[srcOff] * wt;
          g += src[srcOff+1] * wt;
          b += src[srcOff+2] * wt;
          a += src[srcOff+3] * wt;
        }
      }
      dst[dstOff] = r;
      dst[dstOff+1] = g;
      dst[dstOff+2] = b;
      dst[dstOff+3] = 255;
    }
  }
  return output;
}

function edge(img) {
  ti[0] = performance.now()
  ti[1] = performance.now()
  context.drawImage(img, ...dim);
  rgb = context.getImageData(...dim);
  rgb = Convolute(rgb, [-1, -1, -1, -1,  8, -1, -1, -1, -1])
  context.putImageData(rgb, 0, 0);
  canvasToFrame(staticAPNG, -2, 1)
}

function ghost(a) {
  var r = [32, 64, 128, 160, 192, 224]
  var g = [8, 16, 32, 64, 128, 192]
  var b = [96, 128, 160, 192, 224, 240]
  /*var r = [32, 64, 112, 144, 176, 208]*/

  /*for (var i = 0; i < 6; i++) {
    var rgba = (00 + r[i].toString(16)).slice(-2) + (00 + g[i].toString(16)).slice(-2) + (00 + b[i].toString(16)).slice(-2);
    palette.push(rgba);
  }
  echoPalette(6, 4)*/

  for (var i = 0; i < a.length; i += 4) {
    a[i+3] = 255;
    if(a[i] == 0 && a[i+1] == 0 && a[i+2] == 0){
      a[i] = 0;
      a[i+1] = 0;
      a[i+2] = 0;
    } else if(a[i] > 12 || a[i+1] > 12 || a[i+2] > 12){
      a[i] = 255;
      a[i+1] = 255;
      a[i+2] = 255;
    } else if(a[i] > 10 || a[i+1] > 10 || a[i+2] > 10){
      a[i] = r[5];
      a[i+1] = g[5];
      a[i+2] = b[5];
    } else if(a[i] > 8 || a[i+1] > 8 || a[i+2] > 8){
      a[i] = r[4];
      a[i+1] = g[4];
      a[i+2] = b[4];
    } else if(a[i] > 6 || a[i+1] > 6 || a[i+2] > 6){
      a[i] = r[3];
      a[i+1] = g[3];
      a[i+2] = b[3];
    } else if(a[i] > 4 || a[i+1] > 4 || a[i+2] > 4){
      a[i] = r[2];
      a[i+1] = g[2];
      a[i+2] = b[2];
    } else if(a[i] > 2 || a[i+1] > 2 || a[i+2] > 2){
      a[i] = r[1];
      a[i+1] = g[1];
      a[i+2] = b[1];
    } else if(a[i] > 0 || a[i+1] > 0 || a[i+2] > 0){
      a[i] = r[0];
      a[i+1] = g[0];
      a[i+2] = b[0];
    };
  }
}

function detect() {
  let seqFrameN = fl.innerHTML.split("\n").filter(function(el) { return el; })
  c.width = dim[2];
  c.height = dim[3];
  new_dim = [...dim]
  if(seqFrameN.length > 1) {
    if(fps == 0){
      echo("Bad FPS")
    } else {
      apngdiff(framearray[seqFrameN[0]-1][0], framearray[seqFrameN[1]-1][0], ((3==seqFrameN.length)?framearray[seqFrameN[2]-1][0]:false));
    }
  } else {
    edge(framearray[seqFrameN[0]-1][0]);
  }
}

var palette = [];
function frame_diff(a, b) {
  var d = {x:[], y:[]};
  for(var y=0;y<dim[3];y++){
    var o = (y+1)*dim[2]
    for(var x=(o-dim[2])*4;x<o*4;x+=4){
      if(b[x+3] !== 0 && a[x+3] == 255 && a[x] == b[x] && a[x+1] == b[x+1] && a[x+2] == b[x+2]){
        b[x+3] = 0;
      } else {
        d.x.push((x/4)+dim[2]-o);
        d.y.push(y);
        //var rgba = (00 + b[x].toString(16)).slice(-2) + (00 + b[x+1].toString(16)).slice(-2) + (00 + b[x+2].toString(16)).slice(-2);
        //if(palette.indexOf(rgba)<0){palette.push(rgba);}
        //evil: indexOf, toString(16), pad zeros
        //reverse with parseInt(hexString, 16)
      }
    }
  }
  d.x.sort((a,b) => a-b);
  d.y.sort((a,b) => a-b);
  new_dim = [d.x[0], d.y[0], d.x[d.x.length-1]-d.x[0]+1, d.y[d.y.length-1]-d.y[0]+1];
}

function draw(x, i) {
  ti[0] = performance.now()
  ti[1] = performance.now()
  c.width = dim[2];
  c.height = dim[3];
  context.drawImage(x, ...dim);
  new_frames[i] = context.getImageData(...dim);
}

function difference(a, b) {
  let d = new_frames[b].data;
  let e = new_frames[a].data;
  for (let i = 0; i < d.length; i += 4) {
    d[i] = Math.abs(d[i] - e[i]);
    d[i+1] = Math.abs(d[i+1] - e[i+1]);
    d[i+2] = Math.abs(d[i+2] - e[i+2]);
  }
  ghost(d);
  context.putImageData(new_frames[b], 0, 0);
}

function subtract(a, b) {
  let d = new_frames[b].data;
  let e = new_frames[a].data;
  for (let i = 0; i < d.length; i += 4) {
    d[i] -= e[i];
    d[i+1] -= e[i+1];
    d[i+2] -= e[i+2];
  }
  ghost(d);
  context.putImageData(new_frames[b], 0, 0);
}

function cropdiff(a, b, c=true){
  frame_diff(new_frames[a].data, new_frames[b].data)
  if(c){
    new_frames[0] = context.getImageData(...dim);
  }
  context.putImageData(new_frames[b], 0, 0);
  crop()
}

function apngdiff(m, s, s2=false) {
  draw(m, 1);
  canvasToFrame(f2, 0);
  let reuse = [false, false, false, false];

  function f1(){
    if(s2){
      reuse[1] = newframe.arri
      reuse[3] = new_dim
    } else {
      reuse[0] = newframe.arri
      reuse[2] = new_dim
    }
    draw(m, 2);
    cropdiff(0, 2, false);
    canvasToFrame(r2, 0);
  }

  function f2(){
    draw(s, 2);
    cropdiff(1, 2);
    canvasToFrame((s2?f3:f1), 1);
  }

  function f3(){
    reuse[0] = newframe.arri
    reuse[2] = new_dim
    draw(s2, 2);
    cropdiff(0, 2);
    canvasToFrame(f1, 2);
  }

  function r2(){
    ti[0] = performance.now()
    ti[1] = performance.now()
    new_dim = reuse[2]
    ABtoFrame(reuse[0], (s2?r3:d1), 1)
  }

  function r3(){
    ti[0] = performance.now()
    ti[1] = performance.now()
    new_dim = reuse[3]
    ABtoFrame(reuse[1], d1, 2)
  }

  function d1(){
    draw(s, 2);
    subtract(1, 2);
    cropdiff(0, 2);
    canvasToFrame(d2, -2);
  }
  
  function d2(){
    draw(s, 2);
    difference(1, 2);
    cropdiff(0, 2);
    canvasToFrame((s2?d3:d6), -2.5);
  }

  function d3(){
    draw(s, 2);
    draw(s2, 3);
    subtract(2, 3);
    cropdiff(0, 3);
    canvasToFrame(d4, -3);
  }

  function d4(){
    draw(s2, 3);
    difference(2, 3);
    cropdiff(0, 3);
    canvasToFrame(d5, -3.5);
  }

  function d5(){
    draw(s2, 3);
    subtract(1, 3);
    cropdiff(0, 3);
    canvasToFrame(d6, -4);
  }

  function d6(){
    if(s2){
      draw(s2, 3);
      difference(3, 1);
    } else {
      draw(s, 2);
      subtract(2, 1);
    }
    cropdiff(0, 1, false)
    canvasToFrame(makeAPNG, (s2?-4.5:-3));
  }
}

function canvasdiff(m, s) {
  context.drawImage(m, ...dim)
  new_frames[0] = context.getImageData(...dim);
  setTimeout(function() {
    context.drawImage(s, ...dim)
    new_frames[1] = context.getImageData(...dim);
    subtract(new_frames[0].data, new_frames[1]);
    setTimeout(function() {
      context.putImageData(new_frames[1], 0, 0);
      setTimeout(function() {
        context.drawImage(s, ...dim);
        new_frames[1] = context.getImageData(...dim);
        difference(new_frames[0].data, new_frames[1]);
        context.putImageData(new_frames[1], 0, 0);
        setTimeout(function() {
          context.drawImage(s, ...dim);
          new_frames[1] = context.getImageData(...dim);
          subtract(new_frames[1].data, new_frames[0]);
          context.putImageData(new_frames[0], 0, 0);
          setTimeout(function() {
            requestAnimationFrame(canvasdiff(m, s));
          }, 1000/fps);
        }, 1000/fps);
      }, 1000/fps);
    }, 1000/fps);
  }, 1000/fps);
}



function APNG() {
  this.width = 0;
  this.height = 0;
  this.numPlays = 0;
  this.playTime = 0;
  this.frames = [];
  this.arri = new Array(0);
}

function Frame() {
  this.left = 0;
  this.top = 0;
  this.width = 0;
  this.height = 0;
  this.numerator = 0;
  this.denominator = 0;
  this.disposeOp = 0;
  this.blendOp = 0;
  this.arri = new Array(0);
  this.IDATs = [];
}

function findPos(ab, type) {
  var offset = 8;
  while (offset < ab.length) {
    var len = ABtoInt32(ab.slice(offset, offset + 4));
    if (readString(ab.slice(offset + 4, offset + 8)) === type) {
      return new Chunk(offset, len, type);
    }
    offset += 4 + 4 + len + 4;
  }
}

function Chunk(offset, len, type) {
  this.offset = offset;
  this.len = len;
  this.type = type;
}



function fromAPNG(arri){
  var IHDR = null;
  var frame = null;
  var frameNumber = 0;
  var apng = new APNG();

  function inapng(type, arri, offset, length) {
    var dv = new DataView(arri.buffer);
    switch (type) {
      case 'IHDR':
        IHDR = arri.subarray(offset + 8, offset + 8 + length);
        apng.width = dv.getUint32(offset + 8);
        apng.height = dv.getUint32(offset + 12);
        break;
      case 'acTL':
        apng.numPlays = dv.getUint32(offset + 8 + 4);
        break;
      case 'fcTL':
        if (frame) {
          apng.frames.push(frame);
          frameNumber++;
        }
        frame = new Frame();
        frame.width = dv.getUint32(offset + 8 + 4);
        frame.height = dv.getUint32(offset + 8 + 8);
        frame.left = dv.getUint32(offset + 8 + 12);
        frame.top = dv.getUint32(offset + 8 + 16);
        frame.numerator = dv.getUint16(offset + 8 + 20);
        frame.denominator = dv.getUint16(offset + 8 + 22);
        apng.playTime += frame.delay;
        frame.disposeOp = dv.getUint8(offset + 8 + 24);
        frame.blendOp = dv.getUint8(offset + 8 + 25);
        if (frameNumber === 0 && frame.disposeOp === 2) {
          frame.disposeOp = 1;
        }
        break;
      case 'fdAT':
        if (frame) {
          frame.IDATs.push(arri.subarray(offset + 8 + 4, offset + 8 + length));
        }
        break;
      case 'IDAT':
        if (frame) {
          frame.IDATs.push(arri.subarray(offset + 8, offset + 8 + length));
        }
        break;
    }
  }

  eachChunk(arri, inapng)
  apng.frames.push(frame);

  apng.frames.forEach(function (frame) {
      var data = [];
      data.push(PNG_signature);
      IHDR.set(int32ToAB(frame.width), 0);
      IHDR.set(int32ToAB(frame.height), 4);
      data.push(makeChunkBytes('IHDR', IHDR));
      frame.IDATs.forEach(function (IDAT) {
          data.push(makeChunkBytes('IDAT', IDAT));
      });
      data.push(IEND);
      data.forEach(function (u){
         frame.arri = frame.arri.concat(Array.from(u))
      })
      frame.IDATs = [];
      data = [];
  });
  return apng;
}



function eachChunk(arri, callback) {
  var dv = new DataView(arri.buffer);
  var offset = 8;
  var type, len, arr;
  do {
    len = dv.getUint32(offset);
    type = readString(arri.subarray(offset + 4, offset + 8));
    arr = callback(type, arri, offset, len);
    offset += 12 + len;
  } while (arr !== false && type != 'IEND' && offset < arri.length);
}

function readString(arri) {
    return String.fromCharCode.apply(String, Array.prototype.slice.call(arri));
}

function utf8ToAB(utf8) {
  var len = utf8.length;
  var arr = new Uint8Array(len);
  for (var i = 0; i < len; i++) {
    arr[i] = utf8.charCodeAt(i);
  }
  return arr;
}

function makeChunkBytes(type, dataBytes) {
    var crc = type.length + dataBytes.length;
    var bytes = new Uint8Array(crc + 8);
    var dv = new DataView(bytes.buffer);

    dv.setUint32(0, dataBytes.length);
    bytes.set(utf8ToAB(type), 4);
    bytes.set(dataBytes, 8);
    dv.setUint32(crc + 4, crc32(bytes, 4, crc));
    return bytes;
};

function int32ToAB(int32) {
    return [int32 >>> 24 & 0xff, int32 >>> 16 & 0xff, int32 >>> 8 & 0xff, int32 & 0xff];
};

function ABtoInt32(ab) {
   return (ab[0] << 24) + (ab[1] << 12) + (ab[2] << 8) + ab[3];
}



var PNG_signature = [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A];
var IEND = [0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E, 0x44, 0xAE, 0x42, 0x60, 0x82];
var newAPNG = [];
var newframe = new Frame();
var frame_counter = -1;
var sequence_number = -1;

function toFrame(fps, bp=[0, 1]){
  ti[1] = performance.now()
  frame_counter += 1;

  if (!frame_counter) {
    var IHDR = findPos(newframe.arri, "IHDR");
    IHDR = newframe.arri.slice(IHDR.offset, IHDR.offset + 12 + IHDR.len)

    newAPNG.push(new Uint8Array(PNG_signature));
    newAPNG.push(new Uint8Array(IHDR)); //IHDR inherited
    newAPNG.push([]); //acTL reserved
  }

  var offset = 8;
  var IDATs = [];
  while (offset < newframe.arri.length) {
    var chunk = newframe.arri.slice(offset, offset + 4);
    var len = ABtoInt32(chunk);
    if (readString(newframe.arri.slice(offset + 4, offset + 8)) === "IDAT") {
      if(chunk[0]||chunk[1]){
        len = newframe.arri.length-8-25-12-12; //-PNG signature -IHDR -UNK -IEND
      }
      IDATs.push(new Chunk(offset, len, "IDAT"));
    }
    offset += 4 + 4 + len + 4;
  }
  //echo("IDATs: " + IDATs.length)

  for (var i = 0; i < IDATs.length; i++) {
    if (!i) {
      //echo(i + "th IDAT size: " + IDATs[i].len)
      sequence_number +=1;
      var fcTL = new Array(0);
      fcTL = fcTL.concat( int32ToAB(26) );
      fcTL = fcTL.concat([0x66, 0x63, 0x54, 0x4C]);
      fcTL = fcTL.concat( int32ToAB(sequence_number) );
      fcTL = fcTL.concat( int32ToAB(new_dim[2]) );
      fcTL = fcTL.concat( int32ToAB(new_dim[3]) );
      fcTL = fcTL.concat( int32ToAB(new_dim[0]) );
      fcTL = fcTL.concat( int32ToAB(new_dim[1]) );
      fcTL = fcTL.concat( int32ToAB(fps[0]).slice(-2) );
      fcTL = fcTL.concat( int32ToAB(fps[1]).slice(-2) );
      fcTL = fcTL.concat( bp ); //disposeOp and blendOp
      fcTL = fcTL.concat( int32ToAB(crc32(fcTL.slice(4, 4+4+26))) );
      newAPNG.push(new Uint8Array(fcTL));
    }

    var IDAT = IDATs[i];
    if (!frame_counter) {
      newAPNG.push(new Uint8Array(newframe.arri.slice(IDAT.offset, IDAT.offset + 12 + IDAT.len)))
    } else {
      var clean_IDAT = newframe.arri.slice(IDAT.offset + 8, IDAT.offset + 8 + IDAT.len);
      var len = IDAT.len + 4;

      sequence_number +=1;
      var fdAT = new Array(0);
      fdAT = fdAT.concat( int32ToAB(len) );
      fdAT = fdAT.concat( [0x66, 0x64, 0x41, 0x54] );
      fdAT = fdAT.concat( int32ToAB(sequence_number) );
      fdAT = fdAT.concat( clean_IDAT );
      fdAT = fdAT.concat( int32ToAB(crc32(fdAT.slice(4, 4 + 4 + len))) );
      newAPNG.push(new Uint8Array(fdAT));
    };
  }
  ti[2] = performance.now()
  //echo((ti[2] - ti[1])/1000 + "s toFrame()")
  ti[3] = performance.now()
  echo("in " + (ti[3] - ti[0])/1000 + "s", 1)
}

function makeAPNG(i, callback=false) {
  newAPNG.push(new Uint8Array(IEND));

  var acTL = new Array(0)
  acTL = acTL.concat([0, 0, 0, 0x08, 0x61, 0x63, 0x54, 0x4C])
  acTL = acTL.concat(int32ToAB(frame_counter + 1));
  acTL = acTL.concat([0, 0, 0, 0]) //loop times, infinity

  var crc = acTL.slice(4, 16);
  acTL = acTL.concat(int32ToAB(crc32(crc, crc.length)))
  newAPNG[2] = new Uint8Array(acTL);

  frame_counter = -1
  newframe = new Frame();
  sequence_number = -1

  //echoPalette();
  echoIMG(ABtoIMG(newAPNG), name.split('.').slice(0, -1).join('.') + " (apng).png");
  document.title = "Make APNG";
  newAPNG = [];
  if (callback){
    callback(i-1)
  }
}



var table = new Uint32Array(256);
for (var i = 0; i < 256; i++) {
  let x = i;
  for (var k = 0; k < 8; k++){
    x = (x & 1) ? 0xEDB88320 ^ (x >>> 1) : x >>> 1;
  }
  table[i] = x;
}
function crc32(ab, start=0, len=0) {
  if (!len){
    len = ab.length - start
  }

  var crc = -1;
  for (var i=start, l = start + len; i < l; i++) {
    crc = crc >>> 8 ^ table[(crc ^ ab[i]) & 0xFF];
  }
  return crc ^ -1;
}

function crop(){
  if(new_dim[0] == undefined){
    new_dim = [0, 0, 1, 1]
    c.width = 1;
    c.height = 1;
    context.clearRect(...new_dim);
  } else {
    let cropped = context.getImageData(...new_dim);
    c.width = new_dim[2];
    c.height = new_dim[3];
    context.putImageData(cropped, 0, 0);
  }
}

function frameSaver(interFrameN){
  ti[1] = performance.now()
  if(interFrameN == 0){
    new_frames[0] = context.getImageData(...dim);
  } else {
    new_frames[1] = context.getImageData(...dim);
    frame_diff(new_frames[0].data, new_frames[1].data)
    new_frames[0] = context.getImageData(...dim);
    context.putImageData(new_frames[1], 0, 0);
    crop()
  }
  ti[2] = performance.now()
  //echo((ti[2] - ti[1])/1000 + "s frameSaver()")
}

function staticAPNG(interFrameN, callback=false){
  ti[0] = performance.now()
  ti[1] = performance.now()

  new_dim = [0, 0, 1, 1]
  c.width = 1;
  c.height = 1;
  context.clearRect(...new_dim);
  canvasToFrame(makeAPNG, interFrameN-1, fpsm, callback, true);
}

var nextFrame = 1;
var start = [true, true];
var fpsm = 1;
function compileframes(multi=true){
  newAPNG = [];
  let seqFrameN = fl.innerHTML.split("\n").filter(function(el) { return el; })
  var lastFrameN;

  start = [true, true];
  fpsm = 1;
  function updateFrame(interFrameN, fpsm){
    if(interFrameN+1 == seqFrameN.length){
      if(1 == seqFrameN.length){
        name = framearray[seqFrameN[interFrameN]-1][1];
        canvasToFrame(staticAPNG, 0, 1);
      } else {
        canvasToFrame(makeAPNG, interFrameN, fpsm);
      }
    } else {
      if(fps == 0){
        echo("Bad fps")
      } else {
        canvasToFrame(delayFrame, interFrameN, fpsm);
      }
    }
    ti[2] = performance.now()
    //echo((ti[2] - ti[1])/1000 + "s canvasing")
  }

  function readFrame(interFrameN, fpsm) {
    ti[0] = performance.now()
    ti[1] = performance.now()

    if (interFrameN == 0&&!bg||!multi&&!bg){
      get_dim(framearray[seqFrameN[interFrameN]-1][0])
    }
    c.width = dim[2];
    c.height = dim[3];
    if(bg){
      context.drawImage(bg, ...dim);
    }
    context.drawImage(framearray[seqFrameN[interFrameN]-1][0], ...dim);

    new_dim = [...dim]
    if(multi && 1 < seqFrameN.length){
      if (start[1]) {
        frameSaver(0);
        start[1] = false;
      } else {
        frameSaver(interFrameN);
      }
      updateFrame(interFrameN, fpsm)
    } else {
      name = framearray[seqFrameN[interFrameN]-1][1];
      if(interFrameN+1 == seqFrameN.length){
        canvasToFrame(staticAPNG, interFrameN, fpsm)
      } else {
        canvasToFrame(staticAPNG, interFrameN, fpsm, delayFrame)
      }
    }
  }

  function delayFrame(interFrameN){
    if(interFrameN == seqFrameN.length){
      readFrame(interFrameN-1, fpsm);
    } else {
      if (start[0]){
        start[0] = false
        lastFrameN = seqFrameN[0]
        delayFrame(interFrameN+1)
      } else {
        if (lastFrameN == seqFrameN[interFrameN]){
          fpsm += 1;
          echo("Frame " + interFrameN + " (delay)")
          delayFrame(interFrameN+1)
        } else {
          lastFrameN = seqFrameN[interFrameN]
          readFrame(interFrameN-1, fpsm);
          fpsm = 1;
        }
      }
    }
  }
  delayFrame(0);
  nextFrame = 2
}

function compileapngs(){
  newAPNG = [];
  let seqAPNG = al.innerHTML.split("\n").filter(function(el) { return el; })
  let reuse = [false, false, false]
  function readFile(interAPNG){
    ti[0] = performance.now()
    ti[1] = performance.now()
    if(interAPNG == seqAPNG.length){
      makeAPNG();
      return;
    }
    var frames = apngarray[seqAPNG[interAPNG]-1].frames
    function readFrame(interFrameN){
      if(interFrameN == frames.length) return;
      var frame = frames[interFrameN];
      //echo((frame.denominator/frame.numerator) + "fps")
      new_dim = [frame.left, frame.top, frame.width, frame.height]

      function toAPNG(arri){
        newframe.arri = arri;
        reuse[0] = seqAPNG[interAPNG];
        document.title = next;
        echo(next)
        //echoIMG(img, next + ".png")
        toFrame([frame.numerator, frame.denominator], [frame.disposeOp, frame.blendOp]);
        if(interFrameN+1 == frames.length){
          readFile(interAPNG+1);
        } else {
          readFrame(interFrameN+1);
        }
      }

      let next = "Frame " + interFrameN + " of APNG " + seqAPNG[interAPNG]
      arri = frame.arri
      img = ABtoIMG(ABtoAB(arri))
      img.onload = () => {
        ti[0] = performance.now()
        ti[1] = performance.now()
        if(interFrameN == 0){
          if(interAPNG == 0){
            get_dim(img)
            c.width = dim[2];
            c.height = dim[3];
            context.drawImage(img, ...dim);
            frameSaver(0);
            toAPNG(arri);
          } else {
            if(reuse[0] == seqAPNG[interAPNG] && reuse[1]){
              new_dim = reuse[1]
              toAPNG(reuse[2])
            } else {
              context.drawImage(img, ...new_dim);
              frameSaver(1);
              var promise = new Promise(canvasToAB(c))
              promise.then(function(arri){
                arri = Array.from(arri);
                if (reuse[0] == seqAPNG[interAPNG]){
                  reuse[1] = new_dim
                  reuse[2] = arri
                } else {
                  reuse[1] = false
                }
                img = ABtoIMG(ABtoAB(arri))
                c.width = dim[2];
                c.height = dim[3];
                context.putImageData(new_frames[0], 0, 0);
                toAPNG(arri);
              });
            }
          }
        } else {
          context.drawImage(img, ...new_dim);
          frameSaver(0);
          toAPNG(arri);
        }
      }
    }
    readFrame(0);
  }
  readFile(0);
}

function editlist(){
  fl.innerHTML = ""
  for(var i=1; i<framearray.length+1; i++){
    fl.innerHTML += i + "\n"
  }
  ready();
}

function apnglist(){
  al.innerHTML = ""
  for(var i=1;i<apngarray.length+1;i++){
    al.innerHTML += i + "\n"
  }

  let e = document.getElementById("mergeapng");
  e.setAttribute("onclick", "compileapngs();")
  e.classList = "next";
}

function ready(){
  let e = document.getElementById("makeapng");
  e.setAttribute("onclick", "compileframes();")
  e.classList = "next";

  e = document.getElementById("detect");
  e.setAttribute("onclick", "detect();")
  e.classList = "reverse";

  e = document.getElementById("resave")
  if(framearray.length == 1){
    e.style.display = "none"
  } else {
    e.style.display = "inline-block"
  }
}

function read(filelist){
  filelist = Array.from(filelist).sort((a,b) => a.name > b.name);
  function readFile(i){
    if(i == filelist.length) return;
    var fr = new FileReader();
    fr.readAsArrayBuffer(filelist[i]);
    fr.onload = () => {
      arri = new Uint8Array(fr.result);
      img = ABtoIMG([arri])
      img.onload = () => {
        if (i == 0){
          name = filelist[0].name;
        }
        framearray.push([img, filelist[i].name]);
        if(i+1 == filelist.length){
          editlist();
        } else {
          readFile(i+1);
        }
      }
    }
  }
  readFile(0);
}

function readapng(filelist){
  filelist = Array.from(filelist).sort((a,b) => a.name > b.name);
  name = filelist[0].name;
  function readFile(i){
    var fr = new FileReader();
    fr.readAsArrayBuffer(filelist[i]);
    fr.onload = () => {
      arri = new Uint8Array(fr.result);
      img = ABtoIMG([arri])
      img.onload = () => {

        var isAPNG = false;
        if (Array.prototype.some.call(PNG_signature, function (b, i) {
          return b !== arri[i];
        })) {
          echo(" &gt; File excluded: " + filelist[i].name + " is not a PNG");
        } else {
          eachChunk(arri, function (type) {
            return !(isAPNG = type === 'acTL');
          });
          if (!isAPNG) {
            echo(" &gt; File excluded: " + filelist[i].name + " is not an APNG");
          } else {
            apngarray.push(fromAPNG(arri));
          }
        }
        if(i+1 == filelist.length){
          apnglist();
        } else {
          readFile(i+1);
        }
      }
    }
  }
  readFile(0);
}

function changebg(f){
  bg = new Image();
  bg.src = window.URL.createObjectURL(f);
  bg.onload = () => {
    get_dim(bg);
    echo("Success loading background")
    addbg.style.display = "none";
    removebg.style.display = "block";
  };
  bg.onerror = () => {
    echo("Failed to load background")
    bg = false;
  };
}

function loaded(){
  tooltip = document.getElementById("tooltip");
  di = document.getElementById("di");
  fl = document.getElementById("framelist");
  al = document.getElementById("apnglist");
  stdout = document.getElementById("stdout");

  if(!fl.isContentEditable){
    fl.setAttribute("onpaste", "plaintext(this, event)");
    fl.setAttribute("contenteditable", "true");
    al.setAttribute("onpaste", "plaintext(this, event)");
    al.setAttribute("contenteditable", "true");
  }

  document.getElementById("viewer").addEventListener('change', (event) => {
    stdout.insertAdjacentHTML("beforeend", "<br>");
    var f = event.target.files[0];
    if (isVideo(get_ext(f))) {
      var v = document.createElement("video");
      v.style = "max-height:400px;"
      v.setAttribute("controls", "");
      v.setAttribute("playsinline", "");
      v.src = window.URL.createObjectURL(f);
      stdout.appendChild(v);
      v.play();
    } else if (isImage(get_ext(f))) {
      var img = document.createElement("img")
      if (isImage(get_ext(f)) == "heic"){
        if (convert){
          var fr = new FileReader();
          fr.readAsArrayBuffer(f);
          fr.onload = () => {
            echoHEIC(decoder.decode(fr.result)[0], f.name.replace(/.HEIC/gi, ".jpg"));
          }
        } else {
          stdout.insertAdjacentHTML("beforeend", "libheif.js is required to view.");
        }
      } else {
        var src = window.URL.createObjectURL(f);
        img.src = src;
        img.style = "max-height:400px;"
        var dl = document.createElement("a");
        dl.download = f.name;
        dl.href = src;
        dl.appendChild(img);
        stdout.appendChild(dl);
      }
    } else if (get_ext(f).toLowerCase()=="swf") {
      try {
        const ruffle = window.RufflePlayer.newest();
        const player = ruffle.createPlayer();
        stdout.appendChild(player);
        var src = window.URL.createObjectURL(f);
        player.load(src);
      } catch {
        stdout.insertAdjacentHTML("beforeend", "Please update <a href='https://github.com/ruffle-rs/ruffle/releases'>Ruffle</a> (choose self-hosted version)");
       } 
    } else {
      stdout.insertAdjacentHTML("beforeend", "Maybe try another program.");
    }
  });

  document.getElementById("frames").addEventListener('change', (e) => {
    framearray = [];
    read(e.target.files);
  });

  document.getElementById("more").addEventListener('change', (e) => {
    read(e.target.files);
  });

  document.getElementById("resave").setAttribute("onclick", "compileframes(false);")

  background.addEventListener('change', (e) => {
    changebg(e.target.files[0]);
  });

  removebg.addEventListener('click', () => {
    bg = false;
    echo("Unloaded background")
    removebg.style.display = "none";
    addbg.style.display = "block";
  });

  apngframes.addEventListener('change', (e) => {
    apngarray = [];
    readapng(e.target.files);
  });

  apngmore.addEventListener('change', (e) => {
    readapng(e.target.files);
  });

  document.addEventListener("dragover", (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  });

  document.addEventListener("drop", (e) => {
    e.preventDefault();
    framearray = [];
    read(e.dataTransfer.files);
  });

  var s = document.createElement("script");
  s.src = "optipng.min.js";
  document.body.appendChild(s);
  s.onload = () => {
    optimize = true;
  }
  s.onerror = () => {
    document.getElementById("oload").style.display = "inline-block";
  }

  var s = document.createElement("script");
  s.src = "libheif.js";
  document.body.appendChild(s);
  s.onload = () => {
    convert = true;
    decoder = new libheif.HeifDecoder();
  }
  s.onerror = () => {
    document.getElementById("lload").style.display = "inline-block";
  }

  var s = document.createElement("script");
  s.src = "ruffle.js?" + Date.now();
  document.body.appendChild(s);
}

var fps = 0;
var framearray = [];
var apngarray = [];
var optimize = false;
var convert = false;
var ti = [0, 0, 0, 0];
var c = document.createElement("canvas");
var context = c.getContext("2d");
var new_frames = [false, false, false, false, false, false]
var bg = false;
var di, dim, orig_dim, new_dim, al, fl, arri, arro, stdout, dl, img, Module, name, rgb, tooltip, decoder;

window.onload = () => {
  document.body.innerHTML = `<div style="margin-bottom:12px;">
<label class="next"><input id="viewer" type="file"></input>🦦 -(Echo file)</label>
<div class="tooltip" style="display:inline-block;" data-tooltip='APNG production:<br>&nbsp;&gt; Use same lossless image with updated changes to update frame with these changes, unchanges are easy task for the frame optimizations to dispose of.<br>&nbsp;&gt; Load optipng.js for additional file size reduction.<br>&nbsp;&gt; Recommend saving APNG as short clips to merge later when making long APNG series.<br><br>Resaving as single-frame APNG may appear larger in file size due to:<br>&nbsp;&gt; Converted to PNG<br>&nbsp;&gt; 32-bit color (has alpha channel)<br>&nbsp;&gt; Full color profile<br>Image viewers behave differently for PNG resaved as single-frame APNG. You can always discard it and keep original.<br><br>Frame optimization standby:<br>&nbsp;&gt; 4000 max dimension, integer downscale when exceeded<br>&nbsp;&gt; Duplicated interframe pixels will become transparent<br>&nbsp;&gt; Crop frame to fit where pixel changes<br>')">🦦 -(Production advices)</div>
<div class="tooltip" id="oload" style="display:none;" data-tooltip='Optimize frames with <a href="https://github.com/LI-NA/optipng.js/tree/master/demo/js" target="_blank">optipng.min.js</a>, save next to HTML then reload this page'>🦦 -(Optimize frames)</div>
<div class="tooltip" id="lload" style="display:none;" data-tooltip='Read HEIC files with <a href="https://github.com/alexcorvi/heic2any/raw/master/src" target="_blank">libheif.js</a>, save next to HTML then reload this page'>🦦 -(HEICide)</div>
</div>
<div id="tooltip" style="position:absolute; margin-top:37px; white-space:initial; background-color:#2d0710; padding:2px 8px; font-family:sans-serif; font-size:90%; z-index:9999999; left:0px; top:0px; right:initial;"></div>
</div>



<div>
<div class="cell" style="position:relative;">
<div class="tooltip" style="top:-8px; position:relative; display:table;">🦦 -(Make)</div>
<label class="next"><input id="frames" type="file" multiple></input>Load Frames</label>
<label class="next"><input id="more" type="file" multiple></input>Load more</label>
<button id="resave" class="next" style="display:none; position:absolute; right:10px; top:40px;">Resave</button>
<label id="addbg" class="next" style="position:absolute; right:10px; top:10px;"><input id="background" type="file"></input>Load background</label>
<button id="removebg" class="reverse" style="display:none; position:absolute; right:10px; top:10px;">Remove background</button>
<div></div>

<div style="display:inline-block; width:340px; vertical-align: text-top;">
<div id="framelist" class="stdout" style="color:#fd6; display:inline-block;" contenteditable="plaintext-only" spellcheck=false></div>
<div style="margin:6px 12px; float:right; width:300px;">Edit list to rearrange, repeat, or skip a frame by number associated to filelist order, please do not exceed current max number.</div>
</div>
<div></div>

<button class="previous" onclick="echo('Filelist is empty!')" id="makeapng">Make APNG</button> <button class="inverse" onclick="echo('Filelist is empty!')" id="detect">emphasizing diffs</button> at <input id="fps" class="next" type="text" oninput="setfps(this.value);" style="padding: 3px 11px; width:22px;" placeholder="Bad"> fps in dimension: <span id="di">-- &times; --</span>
</div>



<div class="cell">
<div class="tooltip" style="top:-8px; position:relative; display:table;">🦦 -(Merge)</div>
<label class="next"><input id="apngframes" type="file" multiple></input>Load APNG</label>
<label class="next"><input id="apngmore" type="file" multiple></input>Load more</label>
<div></div>

<div style="display:inline-block; width:340px; vertical-align: text-top;">
<div id="apnglist" class="stdout" style="color:#fd6; display:inline-block;" contenteditable="plaintext-only" spellcheck=false></div>
<div style="margin:6px 12px; float:right; width:300px;">Edit list to rearrange, repeat, or skip APNG series.</div>
</div>
<div></div>

<button class="previous" onclick="echo('APNG list is empty!')" id="mergeapng">Merge APNG</button>
</div>
</div>



<div class="stdout" id="stdout">🦦 -(Output)</div>`
  loaded();
  lazyload();
  //document.addEventListener("click", Expander);
}
</script>
<body class="exitmenu">1. Set up and run Schande.bat for its HTTP server from <a href="https://github.com/Rukario/Schande">https://github.com/Rukario/Schande</a><br>
2. Take me to Schande.bat, then launch <a href="http://localhost:8886/APNG Maker.html">http://localhost:8886/APNG Maker.html</a></body>
</html>
