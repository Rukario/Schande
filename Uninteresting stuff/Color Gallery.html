<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="format-detection" content="telephone=no">
<meta name="viewport" content="user-scalable=0">
<title>Color Gallery</title>
<style>
:root {
  color-scheme: light dark;

  --color-background: Canvas;
  --color-background: #10100c;

  --color-foreground: CanvasText;
  --color-foreground: #088;
}

body {
  caret-color: #ffbbff;
  font-family: courier;
  font-size: 14px;
  user-select: none;
  -webkit-text-size-adjust: none;
  -webkit-user-select: none;
}

::selection {
  background: rgba(255, 192, 255, 0.25);
}

[contenteditable]:focus, input:focus {
  outline: none;
}

.editor {
  padding: 8px 12px;
  width: calc(100% - 24px);
  min-height: 12px;
  line-height: 1.1;
  white-space: pre-wrap;
}

a, a.next {
  text-decoration: none;
  color: #ccbb77;

  &:visited {
    color: #efdfa8;
  }
}

img {
  vertical-align: top;
}

.fileThumb {
 scroll-margin-top: 250px;
}

h1, h2, h3, h4, h5, h6 {
  margin: 4px;
}

.colorset, .colorview {
  color: #bfddc6;
  cursor: pointer;
  display: inline-block;
}

.colorsel {
  background-color: #c60;
  color: #fc3;
  border: 1px solid #842;
  margin: -1px;
}

.hyperlink {
  color: #bfddc6;
  text-decoration: underline;
}

.tang {
  background-color: #620;
  color: #efd;
  border: 1px solid #842;
  margin: -1px;
}

.pulse {animation: bl 1000ms linear infinite;}
@keyframes bl{0%{opacity:100%;} 50%{opacity:50%;} 100%{opacity:100%;}}

input[type="text"] {
  padding: 3px 11px; /*Firefox: padding:3px 11px 4px;*/
  width: 86px;
}

input[type="file"] {
  display: none;
}

input[type="color"] {
  width: 0;
  height: 0;
  padding: 0;
  margin: 0;
  border: 0;
  opacity: 0;
}

ul {
  display: inline-grid;
  grid-template-rows: repeat(20, 1fr);
  grid-auto-flow: column;
  grid-column-gap: 10px;
  list-style: none;
  padding: 0;
  margin: 0;
}

::placeholder {
  color: #3cb;
}

.cell {
  position: relative;
  display: inline-block;
  cursor: pointer;
  line-height: 1.1;
  background-color: #333;
  border: 2px solid #000;
  width: 75px;
  height: 44px;
}

.minicell {
  background-color: #333;
  border: 1px solid #000;
  width: 18px;
  height: 11px;
}

#colortable {
  vertical-align: top;
  display: inline-block;
  position: relative;
  color: #000;
  min-width: 316px;
  max-width: 316px;
  line-height: 0;
}

#colorlist {
  display: inline-block;
  vertical-align: top;
  white-space: pre;
  margin-bottom: 96px;
}

#minimap {
  vertical-align: top;
  display: none;
  position: relative;
  color: #000;
  min-width: 80px;
  max-width: 80px;
  line-height: 0;
}

#gallery_tooltip {
  position: absolute;
  display: none;
  z-index: 1;
}

#more {
  display: none;
  border: 16px solid transparent;
  border-bottom: 96px solid transparent;
  background-clip: padding-box;
}

#fadeends {
  line-height: 0;
}

.previous, .reverse, .inverse, .next, .tangerine, .brown {
  white-space: nowrap;
  font-family: sans-serif;
  font-size: 90%;
  position: relative;
  display: inline-block;
  border: 1px solid #033;
  border-radius: 0px;
  padding: 4px 11px;
  margin: 2px;
  line-height: 1.1;
}

.next {
  color: #6fe;
  background-color: #066;
}

.ahref {
  text-decoration: none;
  font-size: 12px;
  font-family: sans-serif;
}

.previous {
  color: #6fe;
  background-color: #399;
}

.reverse {
  background-color: #428;
  color: #d9f;
  border: 1px solid #214;
}

.inverse {
  background-color:#d9f;
  color:#428;
  border: 1px solid #214;
}

.tangerine {
  background-color: #c60;
  color: #fc3;
  border: 1px solid #842;
}

.brown {
  background-color: #620;
  color: #620;
  border: 1px solid #842;
}

.droponly {
  display: inline-block;
  padding: 0px 3px;
  cursor: pointer;
  line-height: 1.1;
}

#main {
  display: inline-block;
  position: relative;
  vertical-align: top;
  display: flex;
}

.dark {
  background-color: rgba(0, 0, 0, 0.5);
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

.close_button {
  position: absolute;
  top:15px;
  right: 15px;
  cursor: pointer;
}

.cursed {
  pointer-events: none;
}

.cursor_tooltip {
  padding: 0px 8px;
  font-family: sans-serif;
  font-size: 90%;
  position: absolute;
  z-index: 2;
  left: 0px;
  top: 0px;
  right: initial;
  display: none;
  white-space: pre-wrap;
}

#cursor_tooltip {
  transition: left .5s linear;
}

#cursor_focus {
  position: absolute;
  left: 0px;
  top: 0px;
  right: initial;
  pointer-events: none;
}

.frame {
  display: inline-block;
  vertical-align: top;
  position: relative;
}

.dot {
  height: 10px;
  width: 10px;
  background-color: #333;
  border-radius: 6px;
  display: inline-block;
}

.stdout {
  white-space: pre-wrap;
  color: #9b859d;
  background-color: #110c13;
  border: 2px solid #221926;
  display: inline-block;
  padding: 6px;
  min-height: 0px;
}

.schande {
  opacity: 0.5;
  position: absolute;
  top: 158px;
  text-align: center;
  line-height: 34px;
  height: 34px;
  cursor: pointer;
  min-width: 40px;
  border: 2px solid transparent;
  background-clip: padding-box;
  box-shadow: inset 0 0 0 2px #c44;
  padding: 2px;
  background-color: #602;
  color: #f45;

  &.save {
    box-shadow:inset 0 0 0 2px #367;
    background-color: #142434;
    color: #2a9;
  }
}

.spinner {
  position: absolute;
  border-top: 9px solid #6cc;
  height: 6px;
  width: 3px;
  top: 162px;
  left: 24px;
  pointer-events: none;
  animation-name: spin;
  animation-duration: 700ms;
  animation-timing-function: linear;
}

.left, .right {
  position: absolute;
  height: 5px;
  width: 5px;
  transform: rotate(45deg);
  top: 166px;
  pointer-events: none;
}

.left {
  border-bottom: 2px solid #f66;
  border-left: 2px solid #f66;
  transform: rotate(45deg);
  left: 86px;
}

.right {
  border-bottom: 2px solid #6cc;
  border-left: 2px solid #6cc;
  transform: rotate(225deg);
  left: 21px;
}

@keyframes spin {
  from {
    transform:rotate(0deg);
  }

  to {
    transform:rotate(360deg);
  }
}

.menu {
  background-color: #110c13;
  color: #9b859d;
}

.exitmenu {
  background-color: var(--color-background);
  color: var(--color-foreground);
}

</style>
<script>
var fc = {"black":"#000000", "anubis":"#292220", "mold":"#222922", "machine":"#202229", "concrete":"#666666", "smoke":"#999999", "cream":"#dcd6cc", "white":"#ffffff", "galaxy":"#111114", "wine":"#500040", "purple":"#992282", "magenta":"#ff33e2", "maroon":"#820045", "rose":"#d60159", "orchid":"#ff6c9b", "cherry blossom":"#ffc9e8", "raspberry":"#aa5c7b", "garnet":"#770017", "cherry":"#d9002b", "cerise":"#ff464e", "rouge":"#ffb9c0", "puce":"#aa7370", "crimson":"#771700", "red":"#c7291b", "scarlet":"#f35548", "chestnut":"#bd3f20", "coral":"#f1876a", "jovial":"#f7c3b3", "rosewood":"#9f400f", "copper":"#e86423", "peach":"#ffc397", "chocolate":"#61300b", "bronze":"#c26718", "orange":"#ff8a00", "honey":"#ffbe6a", "caramel":"#aa7e4a", "gold":"#ffc11d", "brass":"#ffd76b", "beeswax":"#c4af22", "lemon":"#ffe900", "beige":"#fff8a8", "olive":"#707916", "fern":"#b4cd20", "tennis ball":"#e5ff00", "pistachio":"#e5ff9f", "forest":"#234d00", "green":"#64c900", "lime":"#adff69", "xanadu":"#c2ffaf", "grass":"#337744", "teal":"#009677", "robin egg":"#2deacf", "mist":"#a3ffe1", "ocean blue":"#1699bb", "cerulean":"#5bd5ff", "arctic":"#caf6ff", "lazuli":"#5050ff", "sky blue":"#80c0ff", "ghost white":"#eef3f6", "ink":"#30228c", "blueberry":"#6660ff", "glaucous":"#aec2ff", "magic":"#f3e9ff", "indigo":"#401187", "electric indigo":"#7f36df", "lavender indigo":"#b796ff", "glossy grape":"#7c6699", "grape":"#4b0078", "violet":"#8904d1", "psychic":"#bb6eff", "lavender":"#e0caff"};

var cn = [
  "black", "anubis", "mold", "machine",
  "galaxy", "raspberry", "grass", "glossy grape",
  "concrete", "smoke", "cream", "white",
  "wine", "purple", "magenta", null,
  "maroon", "rose", "orchid", "cherry blossom",
  "garnet", "cherry", "cerise", "rouge",
  "crimson", "red", "scarlet", "puce",
  null, "chestnut", "coral", "jovial",
  null, "rosewood", "copper", "peach",
  "chocolate", "bronze", "orange", "honey",
  null, "caramel", "gold", "brass",
  null, "beeswax", "lemon", "beige",
  "olive", "fern", "tennis ball", "pistachio",
  "forest", "green", "lime", "xanadu",
  null, "teal", "robin egg", "mist",
  null, "ocean blue", "cerulean", "arctic",
  null, "lazuli", "sky blue", "ghost white",
  "ink", "blueberry", "glaucous", null,
  "indigo", "electric indigo", "lavender indigo", "magic",
  "grape", "violet", "psychic", "lavender"
];

var palette = [
  ["concrete", "smoke", "cream", "white"],
  ["black", "galaxy", "anubis", "mold", "machine"],
  ["wine", "maroon", "garnet", "crimson", "chocolate", "olive", "forest", "ink", "indigo", "grape"],
  ["rosewood"],
  ["purple", "rose", "cherry", "red", "chestnut", "bronze", "beeswax", "fern", "green", "teal", "ocean blue", "lazuli", "blueberry", "electric indigo", "violet"],
  ["cerise", "scarlet", "copper", "orange", "gold", "lemon", "tennis ball", "lime", "robin egg", "cerulean", "sky blue", "glaucous", "lavender indigo", "psychic"],
  ["magenta", "orchid", "coral"],
  ["cherry blossom", "rouge", "jovial", "peach", "honey", "brass", "beige", "pistachio", "xanadu", "mist", "arctic", "ghost white", "magic", "lavender"],
  ["raspberry", "puce", "caramel", "grass", "glossy grape"]
];

var colorsets = {};
var pictures = {};
var swatches = {};
function opendb(file, callback, resolve) {
  const xhr = new XMLHttpRequest();
  let isTainted = true;
  xhr.overrideMimeType('application/json');
  xhr.open('GET', file, true);
  xhr.setRequestHeader('Cache-Control', 'no-cache, no-store, max-age=0');
  xhr.send();
  xhr.onreadystatechange = () => {
    isTainted = false;
    if (xhr.readyState === 4) {
      if (xhr.status !== 404 && xhr.responseText) {
        callback(JSON.parse(xhr.responseText));
        resolve(true);
      } else if (xhr.responseText) {
        local_tooltip.style.display = 'inline-block';
        local_tooltip.textContent = '⚠';
        local_tooltip.dataset.tooltip = file + ' not found! (404 error)';
      } else {
        local_tooltip.style.display = 'inline-block';
        local_tooltip.textContent = '⚠';
        local_tooltip.dataset.tooltip = "couldn't access " + file + '! (non-404 error)';
      }
    }
  }
}

var realwidth = (t) => {
  if (!t.naturalWidth) {
    return setTimeout(realwidth, 10, t);
  }
  t.style.width = "initial";
}

function lazyload() {
  var imageObserver = new IntersectionObserver(function(entries, observer) {
    entries.forEach(function(e) {
      if (e.isIntersecting) {
        let t = e.target;
        t.src = t.dataset.src;
        setTimeout(realwidth, 10, t);
        imageObserver.unobserve(t);
      }
    });
  });

  var lazyloadImages = document.querySelectorAll('.lazy');
  lazyloadImages.forEach(function(e) {
    e.classList.remove('lazy');
    e.style.height = '200px';
    e.style.width = '300px';
    imageObserver.observe(e);
  });
}

function ABtoUTF8(ta) {
  return ta.map((t) => typeof t === 'string' ? t : t.outerHTML).join('');
}

function makedots(cs, pos) {
  var newbar = [];

  if (cs.length == 1) {
    const d = document.createElement ('DIV');
    d.classList = 'droponly';
    d.dataset.color = 'droponly';
    d.dataset.tooltip = 'drop only';
    d.textContent = '✨';
    return [d];
  }

  const gradientbg = [];

  while (pos < cs.length) {
    var r1 = cs[pos];
    var r2 = cs[pos+1];
    var r3 = cs[pos+2];
    var bc = 'rgba(0, 0, 0, 0.5)';
    var bt = r2;
    var tr = '';
    var st = '';
    if (r2%4 == 2) {
      tr = 'semi-translucent ';
    } else if (r2%4 === 3) {
      tr = 'translucent ';
    }
    if (r2 > 7) {
      tr += 'metallic ';
      st = '✨';
      bt -= 8;
    } else if (r2 > 3) {
      tr += 'pearlescent ';
      st = '💫';
      bt -= 4;
    }
    if (r1 === 'black' || r1 === 'galaxy') {
      bc = '#556';
      bt += 1;
    }
    if (r3 == 2) {
      if (creative && creative.classList.contains('previous')) {
        pos += 3;
        continue;
      }
      newbar[newbar.length-1][0].push(fc[r1]);
    } else {
      newbar.push([[fc[r1]], '']);
    }
    newbar[newbar.length-1][1] += "<div style='display:inline-block; padding:0px 3px; cursor:pointer;' data-color='" + r1 + "' data-tooltip='" + tr + r1 + "'><div class='dot' style='pointer-events:none; height:" + (12-2*bt) + "px; width:" + (12-2*bt) + "px; border:" + bt + "px solid " + bc + "; background: transparent; color:rgba(255, 255, 255, 0.5); font-size:15px; filter: grayscale(100%);'>" + st + "</div></div>";
    pos += 3;
  }

  for (const color of newbar) {
    const width = 12 + color[0].length*18 - 18;
    const fcc = [];

    fcc.push(color[0][0] + " 6px");
    for (const [n, o] of color[0].entries()) {
      fcc.push(o + " " + (6+18*n) + "px");
    }
    fcc.push(color[0][color[0].length-1]);

    const d1 = document.createElement("DIV");
    d1.style.position = "absolute";
    d1.innerHTML = color[1];

    const d3 = document.createElement("DIV");
    d3.classList = "dot";
    d3.style = `pointer-events:none; height: 12px; width: ${width}px; border: none; background: linear-gradient(90deg, ${fcc.join(", ")});`;

    const d2 = document.createElement("DIV");
    d2.style.padding = "0 3px";
    d2.appendChild(d3);

    const di = document.createElement("DIV");
    di.style.display = "inline-block";
    di.appendChild(d1);
    di.appendChild(d2);
    gradientbg.push(di);
  }

  return gradientbg;
}

function galleryset2() {
  var buffer = "";
  for (const gset of galleryset[1]) {
    buffer += "<div class='frame'><a class='fileThumb' href='" + gset + "'><img class='lazy' data-src='" + gset + "'></a></div>";
  }
  gallery.insertAdjacentHTML("beforeend", buffer);
  lazyload();
  more.style.display = "none"; 
}

function cssel() {
  const links = document.querySelectorAll(".colorset");
  const orig_colorset = colorset ? colorset.replace(/(^cs\s|\smas$)/g, '') : false;
  for (const link of links) {
    if (colorset && link.innerHTML.toLowerCase().replace(/(^cs\s|'|\smas$)/g, '') == orig_colorset) {
      link.classList.add("colorsel");
    } else {
      link.classList.remove("colorsel");
    }
  }
}

function addtogallery(k) {
  const i = document.createElement('IMG');
  i.classList = 'lazy';
  i.dataset.src = k;

  const a = document.createElement('A');
  a.classList = 'fileThumb';
  a.href = k;
  a.appendChild(i);

  const d = document.createElement('DIV');
  d.classList = 'frame';
  d.appendChild(a);

  gallery.appendChild(d);
}

var galleryset = [[], []];
function makegallery() {
  if (!editor.textContent.startsWith('Connect to Bad Dragon')) {
    echo("Replace this text field with 'Connect to Bad Dragon' and release me from liability.\nThis might strain Bad Dragon server/your computer and I'll not be held responsible for that.\n")
    return;
  }

  more.style.display = 'none';
  while (gallery.firstChild) {
    gallery.lastChild.remove();
  };

  const lines = editor.textContent.replace(/Bad Dragon\//g, 'https://da6npmvqm28oa.cloudfront.net/inventory-toy-services/').replace(/\<br\>/g, '\n').split('\n');
  const bookmarks = lines.filter((e) => {
    return (
      e &&
      !e.startsWith('SHAME ') && (
        e.toLowerCase().endsWith('.jpg') ||
        e.toLowerCase().endsWith('.png')
      )
    )
  });

  for (const bookmark of bookmarks) {
    addtogallery(bookmark);
  }

  for (const custom_twins of pictures['custom twins']) {
    let featured = false;
    const k = Object.keys(custom_twins)[0];
    const ct = document.createElement('DIV');

    for (const cs of custom_twins[k]) {
      if (cs[0].toLowerCase().replace(/'/g, '') === colorset) {
        featured = true;
      }

      const d = document.createElement('DIV');
      d.innerHTML = '&gt;';

      const s = document.createElement('DIV');
      s.classList = 'colorset';
      s.innerHTML = cs[0];

      d.appendChild(s);
      d.append(...makedots(cs, 1));
      ct.appendChild(d);
    }

    if (featured) {
      addtogallery(k);

      const di = document.createElement('DIV');
      di.style.display = 'inline-block';
      di.style.verticalAlign = 'top';
      di.appendChild(ct);

      gallery.appendChild(di);
    }
  }

  galleryset = [[], []];
  for (const [i, picture] of pictures[colorset].entries()) {
    if (i < 12) {
      galleryset[0].push(picture);
    } else {
      galleryset[1].push(picture);
    }
  }

  for (const gset of galleryset[0]) {
    addtogallery(gset);
  }

  cssel();
  lazyload();

  if (pictures[colorset].length > 11) {
    more.textContent = 'Load ' + (pictures[colorset].length-12) + ' more pictures';
    more.style.display = 'inline-block'; 
  }
}

function replacegallery() {
  more.style.display = 'none'; 
  while (gallery.firstChild) {
    gallery.lastChild.remove();
  }
  galleryset = [[], []];

  const lines = editor.textContent.replace(/Bad Dragon\//g, 'https://da6npmvqm28oa.cloudfront.net/inventory-toy-services/').replace(/\<br\>/g, '\n').split('\n');
  const bookmarks = lines.filter((e) => {
    return (
      e &&
      !e.startsWith('SHAME ') && (
        e.toLowerCase().endsWith('.jpg') ||
        e.toLowerCase().endsWith('.png')
      )
    )
  });

  for (const bookmark of bookmarks) {
    galleryset[0].push(bookmark);
  }

  for (const gset of galleryset[0]) {
    addtogallery(gset);
  }

  rainbow = [];
  for (const line of lines) {
    if (line in colorsets && colorsets[line] != true){
      let cs = colorsets[line];
      rainbowfade = false;
      for (var o=1; o<cs.length; o+=3) {
        rainbow.push(cs[o], 0, rainbowfade?2:0);
        rainbowfade = true;
        if (rainbow.length > 408*3) {
          rainbow = rainbow.slice(3);
          rainbow[2] = 0;
        }
      }
      rainbowfade = false;
    } else if (line == 'palette') {
      for (const p of palette) {
        rainbowfade = false;
        for (const palett of p) {
          rainbow.push(palett, 0, rainbowfade?2:0);
          rainbowfade = true;
          if (rainbow.length > 408*3) {
            rainbow = rainbow.slice(3);
            rainbow[2] = 0;
          }
        }
        rainbowfade = false;
      }
    } else if (line in fc) {
      rainbow.push(line, 0, rainbowfade?2:0);
      rainbowfade = true;
      if (rainbow.length>408*3) {
        rainbow = rainbow.slice(3);
        rainbow[2] = 0;
      }
    } else {
      rainbowfade = false;
    }
  }

  rainbowfade = false;
  while (fadebar.firstChild) {
    fadebar.lastChild.remove();
  }
  fadebar.append(...makedots(rainbow, 0));
  const b = document.createElement('BUTTON');
  b.innerHTML = 'ꍯ';
  b.classList = 'dark';
  b.id = 'fadeends';
  b.style.display = 'none';
  b.addEventListener('click', () => {
    rainbowfade = false;
    fadeends.display = 'none';
  });
  b.dataset.tooltip = 'Fade ends';
  fadebar.appendChild(b);

  colorset = undefined;
  cssel();
  lazyload();
}

function echoIMG(src) {
  return '<img style="vertical-align: middle;" src="' + src + '">';
}

function makelinks(cs, cl = 'colorset') {
  const c = colorsets[cs];
  const ta = [];
  if (c[0]) {
    if (Array.isArray(c[0])) {
      ta.push([c[0][0], ...c[0].slice(2)].join('/'));
      if (c[0][1]) {
        ta.push(' ꍯ ' + c[0][1]);
      }
    } else {
      ta.push('' + c[0]);
    }
  }
  let lowkey = cs.toLowerCase();
  if (lowkey in swatches) {
    if (Array.isArray(swatches[lowkey])) {
      for (const ent of swatches[lowkey]) {
        ta.push('\n', ent['description'], '\n', echoIMG(ent['swatchImage']));
      }
    } else {
      ta.push('\n', swatches[lowkey]['description'], '\n', echoIMG(swatches[lowkey]['swatchImage']));
    }
    if (lowkey + ' mas' in swatches) {
      const swatchmas = swatches[lowkey + ' mas']
      if (swatchmas['description'].toLowerCase().replace(/\./g, '') != swatches[lowkey]['description'].toLowerCase().replace(/\./g, '')) {
        ta.push('\n ꍯ ', swatchmas['description'], '\n');
      } else {
        ta.push(' ꍯ ');
      }
      ta.push(echoIMG(swatchmas['swatchImage']));
    } else if ('cs ' + lowkey in swatches) {
      ta.push(' ꍯ Swap available');
    } else if (Array.isArray(c[0]) && c[0][1]) {
      ta.push(' ꍯ Swap N/A or naming issue');
    }
  }
  const d = document.createElement('DIV');
  d.classList.add(cl);
  if (Array.isArray(c[0])) {
    d.dataset.colorTheme = c[0][0];
    if (c[0][1]) {
      d.dataset.colorTheme2 = c[0][1];
    }
    if (c[0].length > 2) {
      d.dataset.colorTheme3 = c[0][2];
    }
    if (c[0].length > 3) {
      d.dataset.colorTheme4 = c[0][3];
    }
    if (c[0].length > 4) {
      d.dataset.colorTheme5 = c[0][4];
    }
  } else {
    d.dataset.colorTheme = c[0];
  }
  d.dataset.tooltip = ABtoUTF8(ta);
  d.innerHTML = cs;
  return d;
}

function makeDIV(t, tooltip, css, c = 'next') {
  const d = document.createElement('DIV');
  d.classList = c;
  if (css) {
    d.style = css;
  }
  if (tooltip) {
    d.dataset.tooltip = tooltip;
  }
  d.textContent = t;

  return d;
};

function beary(c, t = '🧸') {
  const d = document.createElement('DIV');
  d.classList = 'tangerine';
  if (c) {
    d.id = c;
  }
  d.style.padding = '4px';
  d.textContent = t;
  return d;
};

function makeUL(ta) {
  const list = document.createElement('UL');
  list.style.whiteSpace = 'nowrap';
  for (const i of Array(ta.length).keys()) {
    const item = document.createElement('LI');
    item.appendChild(document.createTextNode(ta[i]));
    list.appendChild(item);
  }
  return list;
}

function button(e, listener, args, pointer = true) {
  if (pointer) {
    e.style.cursor = 'pointer';
  }
  listener(e, args);
  return e;
}

function colorline(b, cs) {
  const d = document.createElement('DIV');
  d.innerHTML = b;
  d.appendChild(makelinks(cs));
  for (const dot of makedots(colorsets[cs], 1)) {
    d.appendChild(dot);
  }
  colorlist.appendChild(d);
}

function newcolorlist(ta = ['Choose a color!']) {
  while (colorlist.firstChild) {
    colorlist.lastChild.remove();
  }
  const h = document.createElement('H3');
  h.append(...ta);
  colorlist.appendChild(h);
}

function colorcell(c) {
  const d = document.createElement('DIV');
  d.classList = 'cell';

  const m = document.createElement('DIV');
  m.classList = 'cell minicell';

  if (c == null) {
    d.dataset.color = '';
  } else {
    const cc = fc[c];
    let cb = '#000000';

    // if (!cc || parseInt(cc.slice(1, 3), 16) < 144 && parseInt(cc.slice(3, 5), 16) < 144 && parseInt(cc.slice(5), 16) < 144) {
    //   cb = "rgba(255, 255, 255, 0.5)";
    // }

    d.style.verticalAlign = 'top';
    d.style.background = cc;
    d.style.color = cb;
    d.dataset.color = c;
    d.innerHTML = c;

    m.style.background = cc;
  }

  colortable.appendChild(d);
  minimap.appendChild(m);
}

function FFdown(e) {
  const t = e.target;
  const id = t.id;
  if (link && t.tagName !== 'A' && !t.dataset.colorset && !t.classList.contains('hyperlink')) {
    link.classList.remove('tang');
    gallery_tooltip.style.display = 'none';

    link.classList.remove('pulse');
    cursor_tooltip.style.display = 'none';
  }

  if (t.classList.contains('colorset')) {
    link = t;
    link.classList.add('tang');

    odnary.style.display = 'none';
    cs.style.display = 'none';
    mas.style.display = 'none';

    const color = link.innerHTML.toLowerCase().replace(/'/g, '');
    if (Object.keys(pictures).includes(color)) {
      odnary.style.display = 'inline-block';
      odnary.dataset.colorset = color;
    }
    if (Object.keys(pictures).includes('cs ' + color)) {
      cs.style.display = 'inline-block';
      cs.dataset.colorset = 'cs ' + color;
    }
    if (Object.keys(pictures).includes(color + ' mas')) {
      mas.style.display = 'inline-block';
      mas.dataset.colorset = color + ' mas';
    }

    const listtoys = [];
    const ct = link.dataset.colorTheme;
    if (ct) {
      checkinv.style.display = 'inline-block';
      checkinv.href = 'https://bad-dragon.com/shop/inventory?colorTheme=' + ct;
    } else {
      checkinv.style.display = 'none';
    }
    if (toys[ct]) {
      listtoys.push(...toys[ct]);
    } else {
      listtoys.push('Unknown caller');
    }

    const ct3 = link.dataset.colorTheme3;
    if (ct3) {
      checkinv_2.style.display = 'inline-block';
      checkinv_2.href = 'https://bad-dragon.com/shop/inventory?colorTheme=' + ct3;
      if (toys[ct3]) {
        listtoys.push(...toys[ct3].map((x) => '2 ' + x));
      } else {
        listtoys.push('2 Unknown caller');
      }
    } else {
      checkinv_2.style.display = "none";
    }

    const ct4 = link.dataset.colorTheme4;
    if (ct4) {
      checkinv_3.style.display = 'inline-block';
      checkinv_3.href = 'https://bad-dragon.com/shop/inventory?colorTheme=' + ct4;
      if (toys[ct4]) {
        listtoys.push(...toys[ct4].map((x) => '3 ' + x));
      } else {
        listtoys.push('3 Unknown caller');
      }
    } else {
      checkinv_3.style.display = 'none';
    }

    const ct5 = link.dataset.colorTheme5;
    if (ct5) {
      checkinv_4.style.display = 'inline-block';
      checkinv_4.href = 'https://bad-dragon.com/shop/inventory?colorTheme=' + ct5;
      if (toys[ct5]) {
        listtoys.push(...toys[ct5].map((x) => '4 ' + x));
      } else {
        listtoys.push('4 Unknown caller');
      }
    } else {
      checkinv_4.style.display = 'none';
    }

    const ct2 = link.dataset.colorTheme2;
    if (ct2) {
      checkinv_mas.style.display = 'inline-block';
      checkinv_mas.href = 'https://bad-dragon.com/shop/inventory?colorTheme=' + ct2;
      if (toys[ct2]) {
        listtoys.push(...toys[ct2].map((x) =>  'ꍯ ' + x));
      } else {
        listtoys.push('ꍯ Unknown caller');
      }
    } else {
      checkinv_mas.style.display = 'none';
    }

    const UL = makeUL(listtoys);
    const rows = listtoys.length >= 20 ? 20 : listtoys.length;
    UL.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    checkcom.dataset.tooltip = UL.outerHTML;
    where = link.getBoundingClientRect();
    gallery_tooltip.style.left = (window.scrollX + where.left -2) + 'px';
    gallery_tooltip.style.top = (window.scrollY + where.top -28) + 'px';
    gallery_tooltip.style.display = 'inline-block';
  } else if (t.dataset.schande) {
    var a = t.parentNode;
    var d = document.createElement('DIV');
    a.appendChild(d);
    t.addEventListener('touchmove', (e) => {e.preventDefault()});

    if (t.classList.contains('save')) {
      if (isTouch) {
        d.classList.add('right');
        const [x, y] = [e.pageX, e.pageY];
        const listener = (z) => {
          if (-20 < (y - z.pageY) && (y - z.pageY) < 20 && (z.pageX - x) > 50) {
            d.classList.remove('right');
            echo(t.dataset.schande);
            t.removeEventListener('touchend', listener);
            delete t.dataset.busy;
            edit();
          }
        };

        if (!t.dataset.busy) {
          t.addEventListener('touchend', listener);
          t.dataset.busy = true;
        }

        t.addEventListener('mouseleave', () => {
          d.classList.remove('right');
        });
      } else {
        const listener = () => {
          echo(t.dataset.schande);
          t.removeEventListener('mouseup', listener);
          edit();
        }
        t.addEventListener('mouseup', listener);
      }
    } else {
      if (isTouch) {
        d.classList.add('left');
        const [x, y] = [e.pageX, e.pageY];
        const listener = (z) => {
          if (-20 < (y - z.pageY) && (y - z.pageY) < 20 && (x - z.pageX) > 50) {
            d.classList.remove('left');
            echo('SHAME ' + t.dataset.schande);
            t.removeEventListener('touchend', listener);
            delete t.dataset.busy;
            edit();
          }
        };

        if (!t.dataset.busy) {
          t.addEventListener('touchend', listener);
          t.dataset.busy = true;
        }

        t.addEventListener('mouseleave', () => {
          d.classList.remove('left');
        });
      } else {
        const listener = () => {
          echo('SHAME ' + t.dataset.schande);
          t.removeEventListener('mouseup', listener);
          edit();
        }
        t.addEventListener('mouseup', listener);
      }
    }
  } else if (id === 'droponly' || t.dataset.color === 'droponly') {
    if (isTouch && t.hasAttribute('data-color') && t.hasAttribute('data-tooltip')) {
      return;
    }

    newcolorlist(['Drop only color sets']);
    for (const css of Object.keys(colorsets)) {
      if (colorsets[css] == true || colorsets[css].length != 1) {
        continue;
      }

      colorline('&gt; ', css);
    }
    cssel();
  } else if (id === 'exotic') {
    const colorsels = [];
    for (const key of Object.keys(colorsets)) {
      const k = colorsets[key];
      let featured = false;
      if (10 < k.length) {
        featured = true;
      } else {
        let pos = 1;
        while (pos < k.length) {
          if (k[pos+2] > 1) {
            featured = true;
            break;
          }
          pos += 3;
        }
      }
      if (featured) {
        colorsels.push(key);
      }
    }

    newcolorlist(['Exotic color sets']);
    for (const cs of colorsels) {
      colorline('&gt; ', cs);
    }
    cssel();
  } else if (t.hasAttribute('data-color')) {
    if (isTouch && t.dataset.tooltip) {
      return;
    }

    const color = t.dataset.color;
    if (!color) {
      newcolorlist();
      return;
    }

    rainbow.push(color, 0, rainbowfade?2:0);
    rainbowfade = true;

    if (rainbow.length > 408*3) {
      rainbow = rainbow.slice(3);
      rainbow[2] = 0;
    }

    while (fadebar.firstChild) {
      fadebar.lastChild.remove();
    }
    fadebar.append(...makedots(rainbow, 0));
    const b = document.createElement('BUTTON');
    b.innerHTML = 'ꍯ';
    b.classList = 'dark';
    b.id = 'fadeends';
    b.addEventListener('click', () => {
      rainbowfade = false;
      fadeends.style.display = 'none';
    });
    b.dataset.tooltip = 'Fade ends';
    fadebar.appendChild(b);

    const god = creative.classList.contains('previous');
    const colorsels = [[], [], []];
    for (const key of Object.keys(colorsets)) {
      const k = colorsets[key];
      let featured = false;
      let pos = 1;
      let p = 0;
      while (pos < k.length) {
        if (k[pos] == color) {
          const pow = k[pos+1];
          p = pow ? pow-1 : 0;

          featured = true;
          if (god && k[pos+2] > 0) {
            featured = false;
          }
        }
        pos += 3;
      }
      if (featured) {
        colorsels[p].push(key);
      }
    }

    newcolorlist([
      color[0].toUpperCase(),
      color.slice(1),
      ' (',
      ...makedots([color, 0, 0], 0),
      ') silicone',
    ]);
    for (const [p, cs] of colorsels.reverse().entries()) {
      colorlist.insertAdjacentHTML('beforeend', ['Translucent<br>', 'Semi-translucent<br>', 'Solid<br>'][p]);
      for (const css of cs) {
        colorline('&gt; ', css);
      }
    }
    cssel();
  } else {
    //console.log('stray click', t);
  }
}

var link = false;
var cur = 0;
var downmove = false;
var busymoving, busypicker, busytyping;
var updatesel = false;
var updatelen = 0;

function FFup() {
  let sel = editor.ownerDocument.defaultView.getSelection();
  let len = sel.toString().length;
  let pos = sel.getRangeAt(0);
  if (link && link.classList.contains('hyperlink')) {
    link.classList.remove('pulse');
    cursor_tooltip.style.display = 'none';
  }
  link = sel.anchorNode.parentNode;
  let ans = null;

  while (cursor_tooltip.firstChild) {
    cursor_tooltip.lastChild.remove();
  }

  if (link.classList.contains('hyperlink')) {
    link.classList.add('pulse');
    where = link.getBoundingClientRect();
    cursor_tooltip.style.left = (window.scrollX + where.left + 6) + 'px';
    cursor_tooltip.style.top = (window.scrollY + where.top + (where.top < 60 ? 30 : -30)) + 'px';
    const a = document.createElement('A');
    a.href = link.innerHTML;
    a.target = '_blank';
    a.classList = 'next ahref';
    a.textContent = 'Open';
    cursor_tooltip.append(a);
    cursor_tooltip.style.display = 'inline-block';
  } else if (len > 0 && len < 256) {
    if (!updatesel) {
      updatesel = window.setInterval(() => {
        let sel = editor.ownerDocument.defaultView.getSelection();
        let len = sel.toString().length;
        if (len !== updatelen){
          updatelen = len;
          FFup();
        }
      }, 500);
    }
    try {
      ans = new Function('return ' + sel.toString().replace(/(\r|\n)/g, ''))().toFixed(10) * 1;
    } catch {
      cursor_tooltip.style.display = 'none';
    }
  } else {
    window.clearInterval(updatesel);
    updatesel = false;
    cursor_tooltip.style.display = 'none';
  }
  let preCaretRange = pos.cloneRange();
  if (ans) {
    where = preCaretRange.getBoundingClientRect();
    cursor_tooltip.style.left = (window.scrollX + where.left) + 'px';
    cursor_tooltip.style.top = (window.scrollY + where.top + 36) + 'px';

    const s = document.createElement('SPAN');
    s.classList = 'tangerine cursed';
    s.style.fontSize = '14px';
    s.textContent = ans;
    cursor_tooltip.append(s);
    cursor_tooltip.style.display = 'inline-block';
  };
  preCaretRange.selectNodeContents(editor);
  preCaretRange.setEnd(pos.endContainer, pos.endOffset);
  cur = preCaretRange.toString().length;
  calc.placeholder = 'Ln:' + editor.textContent.substr(0, cur).split('\n').length + ' Pos:' + cur;
}

function plaintext(e) {
  e.preventDefault();
  var text = e.clipboardData.getData('text/plain').replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
  document.execCommand('insertHTML', false, text);
}

function echo(B, b) {
  if (!b) {
    B = '\n' + B;
  } else {
    B = ' ' + B;
  }
  editor.insertAdjacentHTML('beforeend', B);
}

function deuni(e) {
  return e.replace(/\\u[\dA-F]{4}/gi, function(match){return String.fromCharCode(parseInt(match.replace(/\\u/g, ''), 16));})
}

function edit() {
  const sel = editor.ownerDocument.defaultView.getSelection();
  if (sel.rangeCount) {
    const pos = sel.getRangeAt(0);
    const preCaretRange = pos.cloneRange();
    const where = preCaretRange.getBoundingClientRect();
    cursor_focus.style.left = (window.scrollX + where.left - 100) + 'px';
    cursor_focus.style.top = (window.scrollY + where.top - 200) + 'px';
    if (
      cursor_focus.offsetTop + 200 < window.pageYOffset ||
      cursor_focus.offsetTop + 200 > window.pageYOffset + window.innerHeight ||
      cursor_focus.offsetLeft + 100 < window.pageXOffset ||
      cursor_focus.offsetLeft + 100 > window.pageXOffset + window.innerWidth
    ) {
      cursor_focus.scrollIntoView({top: 0, behavior: 'smooth', inline: 'start'})
    }
  }

  const h = editor.textContent.replace(/<br>/g, '\n').replace(/https:\/\/da6npmvqm28oa.cloudfront.net\/inventory-toy-services\//g, 'Bad Dragon/')
  const n = encodeURIComponent(h).length;
  gallerysave.textContent = 'Save ' + n + '/4085';
  if (4085 < n){
    gallerysave.classList = 'previous';
  } else {
    gallerysave.classList = 'next';
  }
}

var Expand = (c, t) => {
  if (!c.naturalWidth) {
    return setTimeout(Expand, 10, c, t);
  }
  c.style.maxWidth = '100%';
  c.style.display = 'block';
  t.style.display = 'none';
  t.style.opacity = '1';
};

var FFclick = (e) => {
  const t = e.target;
  const a = t.parentNode;
  if (
    a.classList &&
    a.classList.contains('fileThumb')
  ) {
    e.preventDefault();
    if (t.dataset.src) {
      const img = document.createElement('IMG');
      img.src = a.href;
      img.style.display = 'none';
      a.appendChild(img);
      t.style.opacity = '0.75';
      setTimeout(Expand, 10, img, t);
    } else {
      a.firstChild.style.display = '';
      a.removeChild(t);
      outbound();
      a.offsetTop < window.pageYOffset && a.scrollIntoView({block: 'start', behavior: 'smooth'});
    }
  }
};

var outbound;
var FFover = (e) => {
  const t = e.target;
  let a = t.parentNode;
  if (
    a.classList &&
    a.classList.contains('fileThumb') &&
    !a.parentNode.dataset.busy
  ) {
    a = a.parentNode;

    const d = document.createElement('DIV');
    const save = document.createElement('DIV');
    save.classList = 'schande save';
    save.textContent = 'Save';

    const schande = document.createElement('DIV');
    schande.classList = 'schande';
    schande.style.left = '48px';
    schande.textContent = 'Schande!';

    d.append(save, schande);
    a.appendChild(d);

    listener = (z) => {
      z.target.style.opacity = 1;
      if (z.target.classList.contains('schande')) {
        z.target.dataset.schande = (t.dataset.src ? t.dataset.src : t.src).replace(/https:\/\/da6npmvqm28oa.cloudfront.net\/inventory-toy-services\//g, "Bad Dragon/");
      }
      z.target.removeEventListener('mouseover', listener);
      let left = () => {
        z.target.style.opacity = 0.5;
        z.target.removeEventListener('mouseleave', left);
      }
      z.target.addEventListener('mouseleave', left);
    }
    d.addEventListener('mouseover', listener);
    outbound = () => {
      setTimeout(() => {
        a.removeChild(d);
      }, 1)
      delete a.dataset.busy;
      a.removeEventListener('mouseleave', outbound);
    }
    a.dataset.busy = true;
    a.addEventListener('mouseleave', outbound);
  }
}

var FFmove = (e) => {
  const t = e.target;
  if (t.dataset.tooltip) {
    tooltip.style.left = e.pageX + 10 + 'px';
    tooltip.style.top = e.pageY + 10 + 'px';
    tooltip.style.display = 'inline-block';
    tooltip.innerHTML = t.dataset.tooltip;
    if (t.classList == 'tangerine') {
      let left = () => {
        t.classList = 'tangerine';
      }
      t.classList = 'brown';
      t.addEventListener('mouseleave', left);
    }
  } else {
    tooltip.style.display = 'none';
  }
}

function hyperlink(utf8) {
  utf8 = utf8.replace(/(https:\/\/.*?)(\"|&quot;|\'|&#x27;|\n|<|&lt;|\)| |$)/g, '<span class="hyperlink">$1</span>$2');
  const new_utf8 = [];
  for (const line of utf8.split('\n')) {
    if (line in colorsets && colorsets[line] != true) {
      new_utf8.push(makelinks(line, 'colorview').outerHTML);
    } else {
      new_utf8.push(line);
    }
  }
  return new_utf8.join('\n');
}

var cursor_focus, cursor_tooltip, gallery_tooltip, local_tooltip, tooltip;
var exotic, dragfile, droponly, link, gallery, gallerylist, gallerysave, creative, colorset, fadebar, toolbar;
var stdout, editor, editdiff, calc;
var odnary, mas, cs;
var rainbow = [];
var rainbowfade = false;
const isTouch = 'ontouchstart' in window;

const neweditor = (v = true) => {
  const d = document.createElement('DIV');
  d.classList = 'editor';
  d.style.display = v ? 'inline-block' : 'none';
  d.setAttribute('contenteditable', 'plaintext-only');
  d.spellcheck = false;
  d.innerHTML = '<br>';

  if (!d.isContentEditable) {
    d.setAttribute('contenteditable', true);
    d.addEventListener('paste', (e) => {
      plaintext(e);
    });
  }

  return d;
}

window.onload = () => {
  while (document.body.firstChild) {
    document.body.lastChild.remove();
  }

  let listener = null;
  const tc = 'click';

  const makelink = (t, c) => {
    const a = document.createElement('A');
    a.classList = 'next';
    a.target = '_blank';
    a.id = c;
    a.textContent = t;
    return a;
  }



  // tooltips
  cursor_focus = document.createElement('DIV');
  cursor_focus.id = 'cursor_focus';
  document.body.appendChild(cursor_focus);

  cursor_tooltip = document.createElement('DIV');
  cursor_tooltip.id = 'cursor_tooltip';
  cursor_tooltip.classList = 'cursor_tooltip';
  document.body.appendChild(cursor_tooltip);

  tooltip = document.createElement('DIV');
  tooltip.id = 'tooltip';
  tooltip.classList = 'dark close_button cursor_tooltip cursed';
  document.body.appendChild(tooltip);

  listener = (e) => {
    e.addEventListener(tc, () => {
      colorset = e.dataset.colorset;
      makegallery();

      link.classList.remove('tang');
      gallery_tooltip.style.display = 'none';
    });
  };

  gallery_tooltip = document.createElement('DIV');
  gallery_tooltip.id = 'gallery_tooltip';

  odnary = button(makeDIV('Gallery'), listener);
  gallery_tooltip.appendChild(odnary);

  for (const [n, c] of ['checkinv', 'checkinv_2', 'checkinv_3', 'checkinv_4'].entries()) {
    gallery_tooltip.appendChild(makelink(n ? n + 1 + '🧺' : '🧺', c));
  }

  mas = button(makeDIV('Mas'), listener);
  gallery_tooltip.appendChild(mas);

  cs = button(makeDIV('Swaps'), listener);
  gallery_tooltip.appendChild(cs);

  gallery_tooltip.appendChild(makelink('ꍯ🧺', 'checkinv_mas'));
  gallery_tooltip.appendChild(beary('checkcom'));
  document.body.appendChild(gallery_tooltip);



  // toolbar
  toolbar = document.createElement('DIV');
  toolbar.id = 'toolbar';
  document.body.appendChild(toolbar);

  main = document.createElement('DIV');
  main.id = 'main';

  colortable = document.createElement('DIV');
  colortable.id = 'colortable';
  main.appendChild(colortable);

  minimap = document.createElement('DIV');
  minimap.id = 'minimap';
  main.appendChild(minimap);

  colorlist = document.createElement('DIV');
  colorlist.id = 'colorlist';
  main.appendChild(colorlist);

  listener = (e) => {
    e.addEventListener(tc, () => {
      if (e.classList == 'next') {
        e.classList = 'previous';
      } else {
        e.classList = 'next';
      }
    });
  };
  creative = button(makeDIV('Creative mode', "Unload color sets of selected color not possible for custom\n> Fade toy's midway and bottom colors\n> Silicones exclusive to wereables\n> Non-white highlights\n> Silicones covered by full cover highlights"), listener, null, false);
  toolbar.appendChild(creative);

  listener = (e) => {
    e.addEventListener(tc, () => {
      newcolorlist();
      for (const css of Object.keys(colorsets)) {
        if (colorsets[css] == true) {
          colorlist.insertAdjacentHTML('beforeend', css);
          continue;
        }
        colorline('&gt; ', css);
      }
      cssel();
    });
  };
  viewall = button(makeDIV('View all', "Can't find a color set? Try this & use your browser's find in page function!"), listener);
  toolbar.appendChild(viewall);

  listener = (e) => {
    e.addEventListener(tc, () => {
      newcolorlist();

      const presorted = {};
      for (const css of Object.keys(colorsets)) {
        if (colorsets[css] == true) {
          continue;
        }

        idx = colorsets[css][0];
        if (Array.isArray(idx)) {
          for (const idp of idx) {
            if (idp && !presorted[idp]) {
              presorted[idp] = css;
            }
          }
        } else if (idx) {
          presorted[idx] = css;
        }
      }

      let index = 1;
      for (const idx of Object.keys(presorted)) {
        while (idx > index) {
          const d = document.createElement('DIV');
          d.innerHTML = index.toString().padStart(4, ' ');
          colorlist.appendChild(d);
          index++;
        }
        index++;

        colorline(idx.padStart(4, ' ') + ' ', presorted[idx]);
      }

      cssel();
    });
  };
  toolbar.appendChild(button(makeDIV('Numbered', 'View color sets in order of color theme ID'), listener));

  let DOMwriter = beary(null, ':?:');

  let ta = [
    '• Choose several colors e.g. sky blue (',
    ...makedots(['sky blue', 0, 0], 0),
    ') copper (',
    ...makedots(['copper', 0, 0], 0),
    ') then chestnut (',
    ...makedots(['chestnut', 0, 0], 0),
    ') for ',
    ...makedots(['sky blue', 0, 0, 'copper', 0, 2, 'chestnut', 0, 2], 0),
    ' fade bar to appear, as way to test as well as to anticipate for blend/smear issue.\n• Write color name or color set name in text field of bookmarked pictures to manipulate fade bar.\n ◦ ',
    makeDIV('Replace gallery'),
    ' to replace fade bar with written color names.\n ◦ ',
    makeDIV('Save'),
    ' to save fade bar for next page visit.\n ◦ Fade ends on non-color line.\n\nBe mindful of translucent silicones\n• Translucent silicones may overpower to each other especially darkened and/or pigmented ones if not become dull or muddled.\n• Use fade bar for blend test of translucent silicones, they become pronounced of that.\n• Solid silicones can create contours on translucent silicones or 3D depth behind translucent silicones.\nOpen ',
    makeDIV('Gallery'),
    ' for color set named <div class="colorview">Arctic Ice</div>',
    ...makedots(['sky blue', 3, 0], 0),
    ' from sky blue (',
    ...makedots(['sky blue', 0, 0], 0),
    ') color group for photo example of translucent silicone.',
  ];

  DOMwriter.dataset.tooltip = ABtoUTF8(ta);
  toolbar.appendChild(DOMwriter);

  fadebar = document.createElement('DIV');
  fadebar.style.display = 'inline-block';
  toolbar.appendChild(fadebar);

  local_tooltip = document.createElement('DIV');
  local_tooltip.classList = 'dark local_tooltip';
  toolbar.appendChild(local_tooltip);



  // colorpicker
  for (const c of cn) {
    colorcell(c);
  }

  droponly = document.createElement('DIV');
  droponly.dataset.tooltip = 'View drop only color sets (unavailable for custom ordering)';
  droponly.classList = 'cell';
  droponly.id = 'droponly';
  droponly.textContent = '✨';
  colortable.appendChild(droponly);

  exotic = document.createElement('DIV');
  exotic.dataset.tooltip = "View all color sets using fades or 4+ color marbles i.e. can't be altered";
  exotic.classList = 'cell';
  exotic.id = 'exotic';
  exotic.style.color = 'rgba(255, 255, 255, 0.5)';
  exotic.textContent = 'Exotic';
  colortable.appendChild(exotic);

  DOMwriter = document.createElement('DIV');
  DOMwriter.dataset.color = '???';
  DOMwriter.dataset.tooltip = 'View color sets with unassigned silicone colors';
  DOMwriter.classList = 'cell';
  DOMwriter.style.color = 'rgba(255, 255, 255, 0.5)';
  DOMwriter.textContent = 'UNK';
  colortable.appendChild(DOMwriter);



  // editor & gallery
  DOMwriter = document.createElement('DIV');
  DOMwriter.style.verticalAlign = 'top';

  stdout = document.createElement('DIV');
  stdout.classList = 'stdout';
  stdout.style.padding = '4px 0 0 0';

  let hz = document.createElement('DIV');
  hz.style.minWidth = '606px';
  hz.whiteSpace ='nowrap';

  let bp = document.createElement('DIV');
  bp.style.padding = '0 4px';
  bp.style.display = 'inline-block';
  bp.innerHTML = '🦦 -(Bookmarked pictures)';
  hz.appendChild(bp);

  listener = (e) => {
    e.addEventListener(tc, replacegallery);
  }
  hz.appendChild(button(makeDIV('Replace gallery'), listener));

  listener = (e) => {
    e.addEventListener(tc, () => {
      if (e.classList.contains('previous')) {
        return;
      }

      const expires = new Date(Date.now() + 365 * 864e5).toUTCString();
      const utf8 = editor.textContent.replace(/<br>/g, '\n').replace(/https:\/\/da6npmvqm28oa.cloudfront.net\/inventory-toy-services\//g, 'Bad Dragon/');
      document.cookie = `gallerysave=${encodeURIComponent(utf8)}; expires=${expires}; path=/; SameSite=Strict;`;
      //no expiry would allow the cookie to be automatically deleted upon browser exit.
      e.classList = 'previous';
      e.textContent = 'Save completed';
    });
  };
  gallerysave = button(makeDIV('Save', 'Save text field as cookie for next page visit', null, 'previous'), listener);
  hz.appendChild(gallerysave);

  calc = document.createElement('INPUT');
  calc.classList = 'next';
  calc.style.width = '100px';
  calc.type = 'text';
  calc.placeholder = 'Calculator';
  hz.appendChild(calc);

  calc.addEventListener('keyup', (e) => {
    let c = calc.value;
    if (!c) {
      calc.style.backgroundColor = '#066';
    } else if (e.code === 'Enter') {
      try {
        calc.value = new Function('return ' + c)().toFixed(10)*1;
      } catch {
        if (c.startsWith('u') && c.length === 5) {
          calc.value = deuni('\\' + c);
        }
      }
    } else {
      try {
        new Function('return ' + c)();
        calc.style.backgroundColor = '#066';
      } catch {
        if (c.startsWith('u') || c.startsWith('0x')) {
          if (c.startsWith('u') && c.length === 5 || c.startsWith('0x') && Number('0x' + c.slice(1))) {
            calc.style.backgroundColor = '#066';
          } else if (c.startsWith('u') && c.length > 5 || c.startsWith('0x') && c.length > 2) {
            calc.style.backgroundColor = '#399';
          } else {
            calc.style.backgroundColor = '#033';
          }
        } else {
          calc.style.backgroundColor = '#399';
        }
      }
    }
  });

  stdout.appendChild(hz);

  editor = neweditor();
  stdout.appendChild(editor);

  editdiff = neweditor(false);
  stdout.appendChild(editdiff);

  DOMwriter.appendChild(stdout);

  editor.addEventListener('mouseup', FFup);

  editor.addEventListener('mousedown', () => {
    downmove = true;
  });

  editor.addEventListener('mouseup', () => {
    downmove = false;
  });

  editor.addEventListener('mousemove', () => {
    if (downmove) {
      clearTimeout(busymoving);
      busymoving = setTimeout(FFup, 100);
    }
  });

  editor.addEventListener('input', () => {
    edit();
  });

  document.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('fileThumb')) {
      dragfile = e.target;
    }
  }, false);

  editor.addEventListener('drop', (e) => {
    if (dragfile) {
      e.preventDefault();
      echo(dragfile.childNodes[0].src.replace(/https:\/\/da6npmvqm28oa.cloudfront.net\/inventory-toy-services\//g, 'Bad Dragon/'));
      edit();
      dragfile = null;
    }
  }, false);

  let utf8 = '';
  const cookies = document.cookie.split(';');
  for (const cookie of cookies) {
    let c = cookie;

    while (c.charAt(0) === ' '){
      c = c.substring(1, c.length);
    };

    if (c.indexOf('gallerysave=') == 0) {
      utf8 = decodeURIComponent(c.substring('gallerysave='.length, c.length));
    }
  }

  gallery = document.createElement('DIV');
  gallery.id = 'gallery';
  gallery.style.display = 'inline-block';
  DOMwriter.appendChild(gallery);

  listener = (e) => {
    e.addEventListener(tc, () => {
      galleryset2();
    });
  }
  more = button(makeDIV('more'), listener);
  more.id = 'more';
  DOMwriter.appendChild(more);

  main.appendChild(DOMwriter);
  document.body.appendChild(main);



  const promises = [];
  promises.push(new Promise((resolve) => {
    opendb('colorsets.json', (x) => {colorsets = x}, resolve);
  }));

  promises.push(new Promise((resolve) => {
    opendb('pictures.json', (x) => {pictures = x}, resolve);
  }));

  promises.push(new Promise((resolve) => {
    opendb('swatches.json', (x) => {swatches = x}, resolve);
  }));

  promises.push(new Promise((resolve) => {
    opendb('toys.json', (x) => {toys = x}, resolve);
  }));

  Promise.all(promises).then(() => {
    editor.innerHTML = hyperlink(utf8);
  });



  newcolorlist(['Choose a color!']);
  document.addEventListener('click', FFclick);
  document.addEventListener('mousemove', FFmove);
  document.addEventListener('mouseover', FFover);
  //document.addEventListener('touchstart', FFdown);
  document.addEventListener('mousedown', FFdown);
}
</script></head><body class="exitmenu">1. Set up and run Schande.bat for its HTTP server from <a href="https://github.com/Rukario/Schande">https://github.com/Rukario/Schande</a>
2. Take me to Schande.bat, then launch <a href="http://127.0.0.1:8886/Color Gallery.html">http://127.0.0.1:8886/Color Gallery.html</a></body></html>
